{% extends "base_modern.html" %}

{% block title %}è‚¡ç¥¨æ¨è - æ™ºèƒ½é€‰è‚¡åŠ©æ‰‹{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">è‚¡ç¥¨æ¨èä¸­å¿ƒ</h1>
    <p class="text-gray-600">åŸºäºæŠ€æœ¯åˆ†æå’Œç«ä»·æ•°æ®çš„æ™ºèƒ½è‚¡ç¥¨æ¨è</p>
</div>

<!-- æ“ä½œæ  -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div class="flex items-center space-x-4">
        <button class="shadcn-button shadcn-button-primary" onclick="runAnalysis()">
            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
            åˆ·æ–°åˆ†æ
        </button>
        <button class="shadcn-button shadcn-button-outline" onclick="exportData()">
            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
            å¯¼å‡ºæ•°æ®
        </button>
    </div>
    
    <div class="flex items-center space-x-2">
        <span class="text-sm text-gray-600">è§†å›¾æ¨¡å¼:</span>
        <div class="flex rounded-lg border border-gray-300 overflow-hidden">
            <button class="view-toggle active" data-view="table" onclick="switchView('table')">
                <i data-lucide="table" class="w-4 h-4"></i>
            </button>
            <button class="view-toggle" data-view="grid" onclick="switchView('grid')">
                <i data-lucide="grid-3x3" class="w-4 h-4"></i>
            </button>
            <button class="view-toggle" data-view="list" onclick="switchView('list')">
                <i data-lucide="list" class="w-4 h-4"></i>
            </button>
        </div>
    </div>
</div>

<!-- ç­›é€‰å™¨ -->
<div class="shadcn-card p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
            <i data-lucide="filter" class="w-5 h-5 mr-2"></i>
            æ™ºèƒ½ç­›é€‰
        </h3>
        <button class="shadcn-button shadcn-button-outline text-sm" onclick="clearFilters()">
            <i data-lucide="x" class="w-3 h-3 mr-1"></i>
            æ¸…é™¤ç­›é€‰
        </button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
        <!-- æ—¥æœŸç­›é€‰ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ææ—¥æœŸ</label>
            <input 
                type="date" 
                id="dateFilter" 
                value="{{ current_date }}" 
                class="shadcn-input"
                onchange="applyDateFilter()"
            >
        </div>
        
        <!-- å¸‚åœºç­›é€‰ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">äº¤æ˜“å¸‚åœº</label>
            <select id="marketFilter" class="shadcn-input" onchange="applyFilters()">
                <option value="">å…¨éƒ¨å¸‚åœº</option>
                <option value="ä¸Šæµ·ä¸»æ¿">ä¸Šæµ·ä¸»æ¿</option>
                <option value="æ·±åœ³ä¸»æ¿">æ·±åœ³ä¸»æ¿</option>
                <option value="ä¸­å°æ¿">ä¸­å°æ¿</option>
                <option value="åˆ›ä¸šæ¿">åˆ›ä¸šæ¿</option>
            </select>
        </div>
        
        <!-- ä¿¡å¿ƒç­‰çº§ç­›é€‰ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ä¿¡å¿ƒç­‰çº§</label>
            <select id="confidenceFilter" class="shadcn-input" onchange="applyFilters()">
                <option value="">å…¨éƒ¨ç­‰çº§</option>
                <option value="very_high">ğŸ”¥ å¼ºçƒˆæ¨è</option>
                <option value="high">âœ… æ¨èä¹°å…¥</option>
                <option value="medium">ğŸ‘€ å€¼å¾—å…³æ³¨</option>
            </select>
        </div>
        
        <!-- è¯„åˆ†èŒƒå›´ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">è¯„åˆ†èŒƒå›´</label>
            <select id="scoreFilter" class="shadcn-input" onchange="applyFilters()">
                <option value="">å…¨éƒ¨è¯„åˆ†</option>
                <option value="0.8-1.0">0.8 - 1.0 (ä¼˜ç§€)</option>
                <option value="0.7-0.8">0.7 - 0.8 (è‰¯å¥½)</option>
                <option value="0.6-0.7">0.6 - 0.7 (ä¸€èˆ¬)</option>
            </select>
        </div>
        
        <!-- ç«ä»·è¡¨ç° -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ç«ä»·è¡¨ç°</label>
            <select id="auctionFilter" class="shadcn-input" onchange="applyFilters()">
                <option value="">å…¨éƒ¨è¡¨ç°</option>
                <option value="strong_up">å¼ºåŠ¿é«˜å¼€ (>2%)</option>
                <option value="mild_up">æ¸©å’Œé«˜å¼€ (0-2%)</option>
                <option value="flat">å¹³å¼€ (Â±0.5%)</option>
                <option value="down">ä½å¼€ (<0%)</option>
            </select>
        </div>
        
        <!-- æœç´¢ -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">æœç´¢è‚¡ç¥¨</label>
            <div class="relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="shadcn-input pl-10" 
                    placeholder="ä»£ç æˆ–åç§°"
                    oninput="applyFilters()"
                >
                <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-3"></i>
            </div>
        </div>
    </div>
</div>

<!-- æ•°æ®ç»Ÿè®¡ -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="shadcn-card p-4 text-center">
        <div class="text-2xl font-bold text-blue-600" id="totalCount">{{ recommendations|length }}</div>
        <div class="text-sm text-gray-600">æ¨èæ€»æ•°</div>
    </div>
    <div class="shadcn-card p-4 text-center">
        <div class="text-2xl font-bold text-green-600" id="highConfidenceCount">
            {{ recommendations|selectattr("confidence", "equalto", "very_high")|list|length }}
        </div>
        <div class="text-sm text-gray-600">å¼ºçƒˆæ¨è</div>
    </div>
    <div class="shadcn-card p-4 text-center">
        <div class="text-2xl font-bold text-purple-600" id="avgScore">
            {% if recommendations %}
                {{ "%.3f"|format(recommendations|map(attribute='total_score')|sum / recommendations|length) }}
            {% else %}
                0.000
            {% endif %}
        </div>
        <div class="text-sm text-gray-600">å¹³å‡è¯„åˆ†</div>
    </div>
    <div class="shadcn-card p-4 text-center">
        <div class="text-2xl font-bold text-orange-600" id="marketCount">
            {{ recommendations|map(attribute='market')|unique|list|length }}
        </div>
        <div class="text-sm text-gray-600">è¦†ç›–å¸‚åœº</div>
    </div>
</div>

<!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
<div id="dataContainer">
    {% if recommendations %}
    
    <!-- è¡¨æ ¼è§†å›¾ -->
    <div id="tableView" class="shadcn-card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('symbol')">
                            è‚¡ç¥¨ä»£ç  <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è‚¡ç¥¨åç§°</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¸‚åœº</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('current_price')">
                            å½“å‰ä»·æ ¼ <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('total_score')">
                            ç»¼åˆè¯„åˆ† <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('auction_ratio')">
                            ç«ä»·æ¯”ç‡ <i data-lucide="arrow-up-down" class="w-3 h-3 inline ml-1"></i>
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¿¡å¿ƒç­‰çº§</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œçŠ¶æ€</th>
                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="tableBody">
                    {% for stock in recommendations %}
                    <tr class="hover:bg-gray-50 transition-colors duration-150" data-stock-id="{{ stock.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-mono text-sm font-medium text-gray-900">{{ stock.symbol }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ stock.stock_name or 'æœªçŸ¥' }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="shadcn-badge shadcn-badge-secondary">{{ stock.market }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-gray-900">Â¥{{ "%.2f"|format(stock.current_price) }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="text-sm font-bold text-blue-600">{{ "%.3f"|format(stock.total_score) }}</div>
                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ (stock.total_score * 100)|round }}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-semibold {{ 'text-green-600' if stock.auction_ratio > 0 else 'text-red-600' }}">
                                {{ "%+.1f"|format(stock.auction_ratio) }}%
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="shadcn-badge {{ 
                                'shadcn-badge-success' if stock.confidence == 'very_high' else 
                                'shadcn-badge-primary' if stock.confidence == 'high' else 
                                'shadcn-badge-warning' 
                            }}">
                                {{ 
                                    'ğŸ”¥ å¼ºæ¨' if stock.confidence == 'very_high' else 
                                    'âœ… æ¨è' if stock.confidence == 'high' else 
                                    'ğŸ‘€ å…³æ³¨' 
                                }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select class="shadcn-input text-xs py-1" onchange="updateStockStatus({{ stock.id }}, this.value)">
                                <option value="pending" {% if stock.status == 'pending' %}selected{% endif %}>å¾…å†³ç­–</option>
                                <option value="bought" {% if stock.status == 'bought' %}selected{% endif %}>å·²ä¹°å…¥</option>
                                <option value="watching" {% if stock.status == 'watching' %}selected{% endif %}>è§‚å¯Ÿä¸­</option>
                                <option value="ignored" {% if stock.status == 'ignored' %}selected{% endif %}>å·²å¿½ç•¥</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="shadcn-button shadcn-button-outline text-xs py-1 px-3" onclick="showStockDetail('{{ stock.symbol }}')">
                                è¯¦æƒ…
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ç½‘æ ¼è§†å›¾ -->
    <div id="gridView" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="gridContainer">
            {% for stock in recommendations %}
            <div class="shadcn-card p-6 hover:shadow-lg transition-all duration-200 border-l-4 {{ 
                'border-green-500' if stock.confidence == 'very_high' else 
                'border-blue-500' if stock.confidence == 'high' else 
                'border-yellow-500' 
            }}" data-stock-id="{{ stock.id }}">
                <!-- è‚¡ç¥¨å¤´éƒ¨ -->
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h3 class="font-bold text-gray-900">{{ stock.symbol }}</h3>
                        <p class="text-sm text-gray-600">{{ stock.stock_name or 'æœªçŸ¥è‚¡ç¥¨' }}</p>
                    </div>
                    <span class="shadcn-badge {{ 
                        'shadcn-badge-success' if stock.confidence == 'very_high' else 
                        'shadcn-badge-primary' if stock.confidence == 'high' else 
                        'shadcn-badge-warning' 
                    }}">
                        {{ 
                            'ğŸ”¥ å¼ºæ¨' if stock.confidence == 'very_high' else 
                            'âœ… æ¨è' if stock.confidence == 'high' else 
                            'ğŸ‘€ å…³æ³¨' 
                        }}
                    </span>
                </div>

                <!-- ä»·æ ¼å’Œè¯„åˆ† -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">å½“å‰ä»·æ ¼</p>
                        <p class="text-xl font-bold text-gray-900">Â¥{{ "%.2f"|format(stock.current_price) }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 mb-1">ç»¼åˆè¯„åˆ†</p>
                        <div class="flex items-center">
                            <p class="text-xl font-bold text-blue-600 mr-2">{{ "%.3f"|format(stock.total_score) }}</p>
                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: {{ (stock.total_score * 100)|round }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å…³é”®æŒ‡æ ‡ -->
                <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                    <div class="bg-gray-50 rounded p-2">
                        <p class="text-xs text-gray-500">ç«ä»·</p>
                        <p class="text-sm font-semibold {{ 'text-green-600' if stock.auction_ratio > 0 else 'text-red-600' }}">
                            {{ "%+.1f"|format(stock.auction_ratio) }}%
                        </p>
                    </div>
                    <div class="bg-gray-50 rounded p-2">
                        <p class="text-xs text-gray-500">ç›®æ ‡</p>
                        <p class="text-sm font-semibold text-green-600">Â¥{{ "%.2f"|format(stock.target_price) }}</p>
                    </div>
                    <div class="bg-gray-50 rounded p-2">
                        <p class="text-xs text-gray-500">æ­¢æŸ</p>
                        <p class="text-sm font-semibold text-red-600">Â¥{{ "%.2f"|format(stock.stop_loss) }}</p>
                    </div>
                </div>

                <!-- ç­–ç•¥å»ºè®® -->
                <div class="mb-4">
                    <p class="text-xs text-gray-500 mb-1">ç­–ç•¥å»ºè®®</p>
                    <p class="text-sm text-gray-700">{{ stock.strategy }}</p>
                </div>

                <!-- çŠ¶æ€å’Œæ“ä½œ -->
                <div class="flex items-center space-x-2">
                    <select class="flex-1 shadcn-input text-xs py-2" onchange="updateStockStatus({{ stock.id }}, this.value)">
                        <option value="pending" {% if stock.status == 'pending' %}selected{% endif %}>å¾…å†³ç­–</option>
                        <option value="bought" {% if stock.status == 'bought' %}selected{% endif %}>å·²ä¹°å…¥</option>
                        <option value="watching" {% if stock.status == 'watching' %}selected{% endif %}>è§‚å¯Ÿ</option>
                        <option value="ignored" {% if stock.status == 'ignored' %}selected{% endif %}>å¿½ç•¥</option>
                    </select>
                    <button class="shadcn-button shadcn-button-outline text-xs py-2 px-3" onclick="showStockDetail('{{ stock.symbol }}')">
                        è¯¦æƒ…
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- åˆ—è¡¨è§†å›¾ -->
    <div id="listView" class="hidden space-y-4" id="listContainer">
        {% for stock in recommendations %}
        <div class="shadcn-card p-6 hover:shadow-md transition-all duration-200" data-stock-id="{{ stock.id }}">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-4 mb-3">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900">{{ stock.symbol }}</h3>
                            <p class="text-sm text-gray-600">{{ stock.stock_name or 'æœªçŸ¥è‚¡ç¥¨' }}</p>
                        </div>
                        <span class="shadcn-badge {{ 
                            'shadcn-badge-success' if stock.confidence == 'very_high' else 
                            'shadcn-badge-primary' if stock.confidence == 'high' else 
                            'shadcn-badge-warning' 
                        }}">
                            {{ 
                                'ğŸ”¥ å¼ºæ¨' if stock.confidence == 'very_high' else 
                                'âœ… æ¨è' if stock.confidence == 'high' else 
                                'ğŸ‘€ å…³æ³¨' 
                            }}
                        </span>
                        <span class="shadcn-badge shadcn-badge-secondary">{{ stock.market }}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">å½“å‰ä»·æ ¼:</span>
                            <span class="font-semibold text-gray-900 ml-1">Â¥{{ "%.2f"|format(stock.current_price) }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">ç»¼åˆè¯„åˆ†:</span>
                            <span class="font-bold text-blue-600 ml-1">{{ "%.3f"|format(stock.total_score) }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">ç«ä»·æ¯”ç‡:</span>
                            <span class="font-semibold ml-1 {{ 'text-green-600' if stock.auction_ratio > 0 else 'text-red-600' }}">
                                {{ "%+.1f"|format(stock.auction_ratio) }}%
                            </span>
                        </div>
                        <div>
                            <span class="text-gray-500">ç›®æ ‡ä»·:</span>
                            <span class="font-semibold text-green-600 ml-1">Â¥{{ "%.2f"|format(stock.target_price) }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">æ­¢æŸä»·:</span>
                            <span class="font-semibold text-red-600 ml-1">Â¥{{ "%.2f"|format(stock.stop_loss) }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">ç­–ç•¥:</span>
                            <span class="text-gray-700 ml-1">{{ stock.strategy }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3 ml-6">
                    <select class="shadcn-input text-sm" onchange="updateStockStatus({{ stock.id }}, this.value)">
                        <option value="pending" {% if stock.status == 'pending' %}selected{% endif %}>å¾…å†³ç­–</option>
                        <option value="bought" {% if stock.status == 'bought' %}selected{% endif %}>å·²ä¹°å…¥</option>
                        <option value="watching" {% if stock.status == 'watching' %}selected{% endif %}>è§‚å¯Ÿä¸­</option>
                        <option value="ignored" {% if stock.status == 'ignored' %}selected{% endif %}>å·²å¿½ç•¥</option>
                    </select>
                    <button class="shadcn-button shadcn-button-outline" onclick="showStockDetail('{{ stock.symbol }}')">
                        <i data-lucide="eye" class="w-4 h-4 mr-2"></i>
                        è¯¦æƒ…
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% else %}
    <!-- ç©ºçŠ¶æ€ -->
    <div class="shadcn-card p-12 text-center">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i data-lucide="trending-up" class="w-10 h-10 text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">æš‚æ— æ¨èæ•°æ®</h3>
        <p class="text-gray-600 mb-6">é€‰æ‹©æ—¥æœŸæˆ–ç‚¹å‡»"åˆ·æ–°åˆ†æ"è·å–æœ€æ–°æ¨è</p>
        <button class="shadcn-button shadcn-button-primary" onclick="runAnalysis()">
            <i data-lucide="play" class="w-4 h-4 mr-2"></i>
            å¼€å§‹åˆ†æ
        </button>
    </div>
    {% endif %}
</div>

<!-- è‚¡ç¥¨è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="stockDetailModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm" onclick="closeStockDetailModal()"></div>
    <div class="fixed inset-x-4 top-8 bottom-8 bg-white rounded-xl shadow-2xl overflow-hidden md:inset-x-auto md:left-1/2 md:w-full md:max-w-6xl md:transform md:-translate-x-1/2">
        <div class="flex items-center justify-between p-6 border-b bg-gradient-to-r from-blue-50 to-purple-50">
            <h3 class="text-xl font-bold text-gray-900">è‚¡ç¥¨è¯¦ç»†åˆ†æ</h3>
            <button onclick="closeStockDetailModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto custom-scrollbar" style="max-height: calc(100vh - 12rem);">
            <div id="stockDetailContent" class="space-y-6">
                <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allStocks = {{ recommendations|tojson }};
    let filteredStocks = [...allStocks];
    let currentView = 'table';
    let sortField = null;
    let sortDirection = 'asc';

    // è§†å›¾åˆ‡æ¢
    function switchView(view) {
        currentView = view;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.view-toggle').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        
        // æ˜¾ç¤º/éšè—è§†å›¾
        document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
        document.getElementById('gridView').classList.toggle('hidden', view !== 'grid');
        document.getElementById('listView').classList.toggle('hidden', view !== 'list');
        
        updateDisplay();
    }

    // åº”ç”¨ç­›é€‰
    function applyFilters() {
        const market = document.getElementById('marketFilter').value;
        const confidence = document.getElementById('confidenceFilter').value;
        const scoreRange = document.getElementById('scoreFilter').value;
        const auctionType = document.getElementById('auctionFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        filteredStocks = allStocks.filter(stock => {
            let match = true;
            
            // å¸‚åœºç­›é€‰
            if (market && stock.market !== market) match = false;
            
            // ä¿¡å¿ƒç­‰çº§ç­›é€‰
            if (confidence && stock.confidence !== confidence) match = false;
            
            // è¯„åˆ†èŒƒå›´ç­›é€‰
            if (scoreRange) {
                const [min, max] = scoreRange.split('-').map(Number);
                if (stock.total_score < min || stock.total_score > max) match = false;
            }
            
            // ç«ä»·è¡¨ç°ç­›é€‰
            if (auctionType) {
                const ratio = stock.auction_ratio;
                switch (auctionType) {
                    case 'strong_up':
                        if (ratio <= 2) match = false;
                        break;
                    case 'mild_up':
                        if (ratio <= 0 || ratio > 2) match = false;
                        break;
                    case 'flat':
                        if (Math.abs(ratio) > 0.5) match = false;
                        break;
                    case 'down':
                        if (ratio >= 0) match = false;
                        break;
                }
            }
            
            // æœç´¢ç­›é€‰
            if (search && !stock.symbol.toLowerCase().includes(search) && 
                !stock.stock_name.toLowerCase().includes(search)) {
                match = false;
            }
            
            return match;
        });
        
        updateDisplay();
        updateStats();
    }

    // æ—¥æœŸç­›é€‰
    function applyDateFilter() {
        const newDate = document.getElementById('dateFilter').value;
        window.location.href = `{{ url_for('recommendations') }}?date=${newDate}`;
    }

    // æ¸…é™¤ç­›é€‰
    function clearFilters() {
        document.getElementById('marketFilter').value = '';
        document.getElementById('confidenceFilter').value = '';
        document.getElementById('scoreFilter').value = '';
        document.getElementById('auctionFilter').value = '';
        document.getElementById('searchInput').value = '';
        
        filteredStocks = [...allStocks];
        updateDisplay();
        updateStats();
        
        showToast('ç­›é€‰å·²æ¸…é™¤', 'info', 1000);
    }

    // æ’åºè¡¨æ ¼
    function sortTable(field) {
        if (sortField === field) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortField = field;
            sortDirection = 'asc';
        }
        
        filteredStocks.sort((a, b) => {
            let aVal = a[field];
            let bVal = b[field];
            
            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }
            
            if (sortDirection === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
        
        updateDisplay();
    }

    // æ›´æ–°æ˜¾ç¤º
    function updateDisplay() {
        if (currentView === 'table') {
            updateTableDisplay();
        } else if (currentView === 'grid') {
            updateGridDisplay();
        } else {
            updateListDisplay();
        }
    }

    // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
    function updateTableDisplay() {
        const tbody = document.getElementById('tableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        filteredStocks.forEach(stock => {
            const row = createTableRow(stock);
            tbody.appendChild(row);
        });
    }

    // æ›´æ–°ç½‘æ ¼æ˜¾ç¤º
    function updateGridDisplay() {
        const container = document.getElementById('gridContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        filteredStocks.forEach(stock => {
            const card = createGridCard(stock);
            container.appendChild(card);
        });
    }

    // æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
    function updateListDisplay() {
        const container = document.getElementById('listContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        filteredStocks.forEach(stock => {
            const item = createListItem(stock);
            container.appendChild(item);
        });
    }

    // åˆ›å»ºè¡¨æ ¼è¡Œ
    function createTableRow(stock) {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-colors duration-150';
        tr.dataset.stockId = stock.id;
        
        const confidenceMap = {
            'very_high': { text: 'ğŸ”¥ å¼ºæ¨', class: 'shadcn-badge-success' },
            'high': { text: 'âœ… æ¨è', class: 'shadcn-badge-primary' },
            'medium': { text: 'ğŸ‘€ å…³æ³¨', class: 'shadcn-badge-warning' }
        };
        
        const confidence = confidenceMap[stock.confidence] || confidenceMap['medium'];
        
        tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="font-mono text-sm font-medium text-gray-900">${stock.symbol}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${stock.stock_name || 'æœªçŸ¥'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="shadcn-badge shadcn-badge-secondary">${stock.market}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-semibold text-gray-900">Â¥${stock.current_price.toFixed(2)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="text-sm font-bold text-blue-600">${stock.total_score.toFixed(3)}</div>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.round(stock.total_score * 100)}%"></div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm font-semibold ${stock.auction_ratio > 0 ? 'text-green-600' : 'text-red-600'}">
                    ${stock.auction_ratio > 0 ? '+' : ''}${stock.auction_ratio.toFixed(1)}%
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="shadcn-badge ${confidence.class}">${confidence.text}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <select class="shadcn-input text-xs py-1" onchange="updateStockStatus(${stock.id}, this.value)">
                    <option value="pending" ${stock.status === 'pending' ? 'selected' : ''}>å¾…å†³ç­–</option>
                    <option value="bought" ${stock.status === 'bought' ? 'selected' : ''}>å·²ä¹°å…¥</option>
                    <option value="watching" ${stock.status === 'watching' ? 'selected' : ''}>è§‚å¯Ÿä¸­</option>
                    <option value="ignored" ${stock.status === 'ignored' ? 'selected' : ''}>å·²å¿½ç•¥</option>
                </select>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button class="shadcn-button shadcn-button-outline text-xs py-1 px-3" onclick="showStockDetail('${stock.symbol}')">
                    è¯¦æƒ…
                </button>
            </td>
        `;
        
        return tr;
    }

    // åˆ›å»ºç½‘æ ¼å¡ç‰‡
    function createGridCard(stock) {
        // å®ç°ç½‘æ ¼å¡ç‰‡åˆ›å»ºé€»è¾‘
        const div = document.createElement('div');
        div.className = `shadcn-card p-6 hover:shadow-lg transition-all duration-200 border-l-4 ${
            stock.confidence === 'very_high' ? 'border-green-500' :
            stock.confidence === 'high' ? 'border-blue-500' : 'border-yellow-500'
        } animate-fade-in`;
        div.dataset.stockId = stock.id;
        
        // å†…å®¹çœç•¥ï¼Œä½¿ç”¨æ¨¡æ¿ä¸­çš„ç»“æ„
        div.innerHTML = `<!-- ç½‘æ ¼å¡ç‰‡å†…å®¹ -->`;
        
        return div;
    }

    // åˆ›å»ºåˆ—è¡¨é¡¹
    function createListItem(stock) {
        // å®ç°åˆ—è¡¨é¡¹åˆ›å»ºé€»è¾‘
        const div = document.createElement('div');
        div.className = 'shadcn-card p-6 hover:shadow-md transition-all duration-200 animate-fade-in';
        div.dataset.stockId = stock.id;
        
        // å†…å®¹çœç•¥ï¼Œä½¿ç”¨æ¨¡æ¿ä¸­çš„ç»“æ„
        div.innerHTML = `<!-- åˆ—è¡¨é¡¹å†…å®¹ -->`;
        
        return div;
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
        document.getElementById('totalCount').textContent = filteredStocks.length;
        document.getElementById('highConfidenceCount').textContent = 
            filteredStocks.filter(s => s.confidence === 'very_high').length;
        
        const avgScore = filteredStocks.length > 0 ? 
            filteredStocks.reduce((sum, s) => sum + s.total_score, 0) / filteredStocks.length : 0;
        document.getElementById('avgScore').textContent = avgScore.toFixed(3);
        
        const markets = [...new Set(filteredStocks.map(s => s.market))];
        document.getElementById('marketCount').textContent = markets.length;
    }

    // æ›´æ–°è‚¡ç¥¨çŠ¶æ€
    async function updateStockStatus(stockId, newStatus) {
        try {
            const response = await makeRequest('/api/update_stock_status', 'POST', {
                id: stockId,
                status: newStatus
            });
            
            if (response.success) {
                showToast('çŠ¶æ€å·²æ›´æ–°', 'success', 1000);
                // æ›´æ–°æœ¬åœ°æ•°æ®
                const stock = allStocks.find(s => s.id === stockId);
                if (stock) {
                    stock.status = newStatus;
                }
            } else {
                showToast(response.message, 'error');
            }
        } catch (error) {
            showToast('æ›´æ–°å¤±è´¥', 'error');
        }
    }

    // æ˜¾ç¤ºè‚¡ç¥¨è¯¦æƒ…
    function showStockDetail(symbol) {
        const stock = allStocks.find(s => s.symbol === symbol);
        if (!stock) return;
        
        const modal = document.getElementById('stockDetailModal');
        const content = document.getElementById('stockDetailContent');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        content.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="loading-skeleton h-32 rounded"></div>
                <div class="loading-skeleton h-32 rounded"></div>
                <div class="loading-skeleton h-32 rounded"></div>
            </div>
        `;
        
        modal.classList.remove('hidden');
        
        // åŠ è½½è¯¦ç»†ä¿¡æ¯
        setTimeout(() => {
            content.innerHTML = generateStockDetailHTML(stock);
            lucide.createIcons();
        }, 300);
    }

    // ç”Ÿæˆè‚¡ç¥¨è¯¦æƒ…HTML
    function generateStockDetailHTML(stock) {
        return `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="shadcn-card p-6">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <i data-lucide="info" class="w-4 h-4 mr-2"></i>
                        åŸºæœ¬ä¿¡æ¯
                    </h4>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">è‚¡ç¥¨ä»£ç :</span>
                            <span class="font-mono font-medium">${stock.symbol}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">è‚¡ç¥¨åç§°:</span>
                            <span class="font-medium">${stock.stock_name || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">æ‰€å±å¸‚åœº:</span>
                            <span class="shadcn-badge shadcn-badge-secondary">${stock.market}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">å½“å‰ä»·æ ¼:</span>
                            <span class="font-bold text-lg">Â¥${stock.current_price.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <!-- è¯„åˆ†è¯¦æƒ… -->
                <div class="shadcn-card p-6">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i>
                        è¯„åˆ†è¯¦æƒ…
                    </h4>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm text-gray-500">ç»¼åˆè¯„åˆ†</span>
                                <span class="font-bold text-blue-600">${stock.total_score.toFixed(3)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.round(stock.total_score * 100)}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm text-gray-500">æŠ€æœ¯è¯„åˆ†</span>
                                <span class="font-semibold text-green-600">${stock.tech_score.toFixed(3)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: ${Math.round(stock.tech_score * 100)}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm text-gray-500">ç«ä»·è¯„åˆ†</span>
                                <span class="font-semibold text-purple-600">${stock.auction_score.toFixed(3)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-purple-600 h-2 rounded-full" style="width: ${Math.round(stock.auction_score * 100)}%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- äº¤æ˜“å»ºè®® -->
                <div class="shadcn-card p-6">
                    <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                        <i data-lucide="target" class="w-4 h-4 mr-2"></i>
                        äº¤æ˜“å»ºè®®
                    </h4>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">å»ºè®®å…¥åœº:</span>
                            <span class="font-semibold text-blue-600">Â¥${stock.entry_price.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">æ­¢æŸä½:</span>
                            <span class="font-semibold text-red-600">Â¥${stock.stop_loss.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">ç›®æ ‡ä½:</span>
                            <span class="font-semibold text-green-600">Â¥${stock.target_price.toFixed(2)}</span>
                        </div>
                        <div class="pt-3 border-t">
                            <span class="text-gray-500 block mb-2">ç­–ç•¥å»ºè®®:</span>
                            <span class="text-gray-700">${stock.strategy}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç«ä»·åˆ†æ -->
            <div class="shadcn-card p-6 mt-6">
                <h4 class="font-semibold text-gray-900 mb-4 flex items-center">
                    <i data-lucide="activity" class="w-4 h-4 mr-2"></i>
                    ç«ä»·åˆ†æè¯¦æƒ…
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-2xl font-bold mb-2 ${stock.auction_ratio > 0 ? 'text-green-600' : 'text-red-600'}">
                            ${stock.auction_ratio > 0 ? '+' : ''}${stock.auction_ratio.toFixed(2)}%
                        </div>
                        <div class="text-sm text-gray-500">ç«ä»·æ¯”ç‡</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold mb-2 text-blue-600">${stock.gap_type || 'unknown'}</div>
                        <div class="text-sm text-gray-500">ç¼ºå£ç±»å‹</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold mb-2 text-purple-600">${(stock.capital_bias || 0).toFixed(3)}</div>
                        <div class="text-sm text-gray-500">èµ„é‡‘åå‘</div>
                    </div>
                </div>
            </div>
        `;
    }

    // å…³é—­è‚¡ç¥¨è¯¦æƒ…æ¨¡æ€æ¡†
    function closeStockDetailModal() {
        document.getElementById('stockDetailModal').classList.add('hidden');
    }

    // è¿è¡Œåˆ†æ
    async function runAnalysis() {
        showToast('å¼€å§‹æ‰§è¡Œè‚¡ç¥¨åˆ†æï¼Œè¯·ç¨å€™...', 'info');
        
        try {
            const response = await makeRequest('/api/run_analysis', 'POST');
            if (response.success) {
                showToast(response.message, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast(response.message, 'error');
            }
        } catch (error) {
            showToast('åˆ†æå¤±è´¥', 'error');
        }
    }

    // å¯¼å‡ºæ•°æ®
    function exportData() {
        const csvContent = generateCSV(filteredStocks);
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `stock_recommendations_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
    }

    // ç”ŸæˆCSV
    function generateCSV(stocks) {
        const headers = ['è‚¡ç¥¨ä»£ç ', 'è‚¡ç¥¨åç§°', 'å¸‚åœº', 'å½“å‰ä»·æ ¼', 'ç»¼åˆè¯„åˆ†', 'ç«ä»·æ¯”ç‡', 'ä¿¡å¿ƒç­‰çº§', 'ç­–ç•¥å»ºè®®'];
        const rows = stocks.map(stock => [
            stock.symbol,
            stock.stock_name || 'æœªçŸ¥',
            stock.market,
            stock.current_price.toFixed(2),
            stock.total_score.toFixed(3),
            stock.auction_ratio.toFixed(1) + '%',
            stock.confidence === 'very_high' ? 'å¼ºçƒˆæ¨è' : 
            stock.confidence === 'high' ? 'æ¨èä¹°å…¥' : 'å€¼å¾—å…³æ³¨',
            stock.strategy
        ]);
        
        return [headers, ...rows].map(row => 
            row.map(field => `"${field}"`).join(',')
        ).join('\n');
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–è§†å›¾åˆ‡æ¢æŒ‰é’®æ ·å¼
        document.querySelectorAll('.view-toggle').forEach(btn => {
            btn.className += ' px-3 py-2 text-sm font-medium border transition-colors duration-200';
            if (btn.classList.contains('active')) {
                btn.className += ' bg-blue-600 text-white border-blue-600';
            } else {
                btn.className += ' bg-white text-gray-700 border-gray-300 hover:bg-gray-50';
            }
        });

        // åˆå§‹åŒ–ç»Ÿè®¡
        updateStats();
        
        // åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();
    });
</script>
{% endblock %}