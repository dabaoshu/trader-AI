{% extends "base_modern.html" %}

{% block title %}æ™ºèƒ½é©¾é©¶èˆ± - æ™ºèƒ½é€‰è‚¡åŠ©æ‰‹{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">æ™ºèƒ½é©¾é©¶èˆ±</h1>
    <p class="text-gray-600">å®æ—¶ç›‘æ§ç³»ç»ŸçŠ¶æ€ï¼ŒæŒæ¡æœ€æ–°è‚¡ç¥¨æ¨è</p>
</div>

<!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ç»„ -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
    <!-- ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ -->
    <div class="shadcn-card p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">ç³»ç»ŸçŠ¶æ€</p>
                <div class="flex items-center mt-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                    <p class="text-2xl font-bold text-gray-900">è¿è¡Œä¸­</p>
                </div>
            </div>
            <div class="p-3 bg-green-100 rounded-full">
                <i data-lucide="activity" class="w-6 h-6 text-green-600"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center justify-between">
            <p class="text-xs text-gray-500">è°ƒåº¦å™¨çŠ¶æ€</p>
            <button class="shadcn-button shadcn-button-outline text-xs px-3 py-1" onclick="toggleScheduler()">
                {{ 'åœæ­¢' if system_status.scheduler_running else 'å¯åŠ¨' }}
            </button>
        </div>
    </div>

    <!-- ä»Šæ—¥æ¨èæ•°é‡ -->
    <div class="shadcn-card p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">ä»Šæ—¥æ¨è</p>
                <p class="text-2xl font-bold text-gray-900 mt-2">{{ system_status.today_recommendations }}</p>
            </div>
            <div class="p-3 bg-blue-100 rounded-full">
                <i data-lucide="trending-up" class="w-6 h-6 text-blue-600"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center justify-between">
            <p class="text-xs text-gray-500">åªè‚¡ç¥¨</p>
            <button class="shadcn-button shadcn-button-outline text-xs px-3 py-1" onclick="runAnalysis()">
                ç«‹å³åˆ†æ
            </button>
        </div>
    </div>

    <!-- é‚®ç®±é…ç½®çŠ¶æ€ -->
    <div class="shadcn-card p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">é‚®ç®±é…ç½®</p>
                <p class="text-2xl font-bold mt-2 {{ 'text-green-600' if system_status.email_configured else 'text-red-600' }}">
                    {{ 'å·²é…ç½®' if system_status.email_configured else 'æœªé…ç½®' }}
                </p>
            </div>
            <div class="p-3 {{ 'bg-green-100' if system_status.email_configured else 'bg-red-100' }} rounded-full">
                <i data-lucide="mail" class="w-6 h-6 {{ 'text-green-600' if system_status.email_configured else 'text-red-600' }}"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center justify-between">
            <p class="text-xs text-gray-500">é€šçŸ¥çŠ¶æ€</p>
            <button class="shadcn-button shadcn-button-outline text-xs px-3 py-1" onclick="location.href='{{ url_for('config') }}'">
                è®¾ç½®é‚®ç®±
            </button>
        </div>
    </div>

    <!-- æœ€åæ›´æ–°æ—¶é—´ -->
    <div class="shadcn-card p-6 hover:shadow-lg transition-all duration-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">æœ€åæ›´æ–°</p>
                <p class="text-2xl font-bold text-gray-900 mt-2" id="lastUpdateTime">{{ system_status.last_update[:19] if system_status.last_update != "ä»æœªæ›´æ–°" else "ä»æœªæ›´æ–°" }}</p>
            </div>
            <div class="p-3 bg-purple-100 rounded-full">
                <i data-lucide="clock" class="w-6 h-6 text-purple-600"></i>
            </div>
        </div>
        <div class="mt-4 flex items-center justify-between">
            <p class="text-xs text-gray-500">æ•°æ®æ—¶é—´</p>
            <button class="shadcn-button shadcn-button-outline text-xs px-3 py-1" onclick="refreshStatus()">
                åˆ·æ–°çŠ¶æ€
            </button>
        </div>
    </div>
</div>

<!-- å®æ—¶äº¤æ˜“æ—¶é’Ÿ -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- äº¤æ˜“æ—¶é’Ÿ -->
    <div class="shadcn-card p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i data-lucide="clock" class="w-5 h-5 mr-2"></i>
            äº¤æ˜“æ—¶é’Ÿ
        </h3>
        <div class="text-center">
            <div class="text-3xl font-bold text-gray-900 mb-2" id="currentTime"></div>
            <div class="text-sm text-gray-600 mb-4" id="currentDate"></div>
            <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium" id="marketStatus">
                <div class="w-2 h-2 rounded-full mr-2"></div>
                <span>åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="shadcn-card p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
            å¿«é€Ÿæ“ä½œ
        </h3>
        <div class="space-y-3">
            <button class="w-full shadcn-button shadcn-button-primary" onclick="runAnalysis()">
                <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                ç«‹å³åˆ†æ
            </button>
            <button class="w-full shadcn-button shadcn-button-outline" onclick="testEmail()">
                <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                æµ‹è¯•é‚®ä»¶
            </button>
            <button class="w-full shadcn-button shadcn-button-secondary" onclick="refreshStatus()">
                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                åˆ·æ–°çŠ¶æ€
            </button>
        </div>
    </div>

    <!-- ç³»ç»Ÿæç¤º -->
    <div class="shadcn-card p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i data-lucide="info" class="w-5 h-5 mr-2"></i>
            ç³»ç»Ÿæç¤º
        </h3>
        <div class="space-y-3 text-sm">
            <div class="flex items-start space-x-2">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0"></i>
                <span class="text-gray-600">9:25-9:29 è‡ªåŠ¨æ‰§è¡Œåˆ†æ</span>
            </div>
            <div class="flex items-start space-x-2">
                <i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                <span class="text-gray-600">æŠ•èµ„æœ‰é£é™©ï¼Œæ“ä½œéœ€è°¨æ…</span>
            </div>
            <div class="flex items-start space-x-2">
                <i data-lucide="mail" class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"></i>
                <span class="text-gray-600">æ¯æ—¥è‡ªåŠ¨å‘é€é‚®ä»¶æŠ¥å‘Š</span>
            </div>
        </div>
    </div>
</div>

<!-- ä»Šæ—¥é‡ç‚¹æ¨è -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900">ä»Šæ—¥é‡ç‚¹æ¨è</h2>
        <a href="{{ url_for('recommendations') }}" class="shadcn-button shadcn-button-outline">
            <span>æŸ¥çœ‹å…¨éƒ¨</span>
            <i data-lucide="arrow-right" class="w-4 h-4 ml-2"></i>
        </a>
    </div>

    {% if recommendations %}
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        {% for stock in recommendations %}
        <div class="shadcn-card p-6 hover:shadow-lg transition-all duration-200 border-l-4 {{ 
            'border-green-500' if stock.confidence == 'very_high' else 
            'border-blue-500' if stock.confidence == 'high' else 
            'border-yellow-500' 
        }}">
            <!-- è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ -->
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h3 class="font-bold text-gray-900">{{ stock.symbol }}</h3>
                    <p class="text-sm text-gray-600">{{ stock.stock_name or 'æœªçŸ¥è‚¡ç¥¨' }}</p>
                </div>
                <span class="shadcn-badge {{ 
                    'shadcn-badge-success' if stock.confidence == 'very_high' else 
                    'shadcn-badge-primary' if stock.confidence == 'high' else 
                    'shadcn-badge-warning' 
                }}">
                    {{ 
                        'ğŸ”¥ å¼ºæ¨' if stock.confidence == 'very_high' else 
                        'âœ… æ¨è' if stock.confidence == 'high' else 
                        'ğŸ‘€ å…³æ³¨' 
                    }}
                </span>
            </div>

            <!-- ä»·æ ¼å’Œè¯„åˆ† -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <p class="text-xs text-gray-500 mb-1">å½“å‰ä»·æ ¼</p>
                    <p class="text-xl font-bold text-gray-900">Â¥{{ "%.2f"|format(stock.current_price) }}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 mb-1">ç»¼åˆè¯„åˆ†</p>
                    <p class="text-xl font-bold text-blue-600">{{ "%.3f"|format(stock.total_score) }}</p>
                </div>
            </div>

            <!-- å…³é”®æŒ‡æ ‡ -->
            <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                <div class="bg-gray-50 rounded p-2">
                    <p class="text-xs text-gray-500">ç«ä»·</p>
                    <p class="text-sm font-semibold {{ 'text-green-600' if stock.auction_ratio > 0 else 'text-red-600' }}">
                        {{ "%+.1f"|format(stock.auction_ratio) }}%
                    </p>
                </div>
                <div class="bg-gray-50 rounded p-2">
                    <p class="text-xs text-gray-500">ç›®æ ‡</p>
                    <p class="text-sm font-semibold text-green-600">Â¥{{ "%.2f"|format(stock.target_price) }}</p>
                </div>
                <div class="bg-gray-50 rounded p-2">
                    <p class="text-xs text-gray-500">æ­¢æŸ</p>
                    <p class="text-sm font-semibold text-red-600">Â¥{{ "%.2f"|format(stock.stop_loss) }}</p>
                </div>
            </div>

            <!-- ç­–ç•¥å»ºè®® -->
            <div class="mb-4">
                <p class="text-xs text-gray-500 mb-1">ç­–ç•¥å»ºè®®</p>
                <p class="text-sm text-gray-700">{{ stock.strategy }}</p>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex space-x-2">
                <button class="flex-1 shadcn-button shadcn-button-outline text-xs py-2" onclick="showStockDetail('{{ stock.symbol }}')">
                    è¯¦ç»†åˆ†æ
                </button>
                <button class="flex-1 shadcn-button shadcn-button-primary text-xs py-2">
                    åŠ å…¥è‡ªé€‰
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="shadcn-card p-12 text-center">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="trending-up" class="w-8 h-8 text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">æš‚æ— æ¨èæ•°æ®</h3>
        <p class="text-gray-600 mb-6">ç‚¹å‡»"ç«‹å³åˆ†æ"è·å–æœ€æ–°è‚¡ç¥¨æ¨è</p>
        <button class="shadcn-button shadcn-button-primary" onclick="runAnalysis()">
            <i data-lucide="play" class="w-4 h-4 mr-2"></i>
            å¼€å§‹åˆ†æ
        </button>
    </div>
    {% endif %}
</div>

<!-- è‚¡ç¥¨è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="stockDetailModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black bg-opacity-50" onclick="closeStockDetailModal()"></div>
    <div class="fixed inset-x-4 top-8 bottom-8 bg-white rounded-lg shadow-xl overflow-hidden md:inset-x-auto md:left-1/2 md:w-full md:max-w-4xl md:transform md:-translate-x-1/2">
        <div class="flex items-center justify-between p-6 border-b">
            <h3 class="text-lg font-semibold text-gray-900">è‚¡ç¥¨è¯¦ç»†åˆ†æ</h3>
            <button onclick="closeStockDetailModal()" class="text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto custom-scrollbar" style="max-height: calc(100vh - 16rem);">
            <div id="stockDetailContent">
                <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // å®æ—¶æ—¶é’Ÿæ›´æ–°
    function updateClock() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
        const dateStr = now.toLocaleDateString('zh-CN', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            weekday: 'long'
        });
        
        document.getElementById('currentTime').textContent = timeStr;
        document.getElementById('currentDate').textContent = dateStr;
        
        // æ›´æ–°å¸‚åœºçŠ¶æ€
        updateMarketStatus(now);
    }
    
    // æ›´æ–°å¸‚åœºçŠ¶æ€
    function updateMarketStatus(now) {
        const hour = now.getHours();
        const minute = now.getMinutes();
        const time = hour * 100 + minute;
        const day = now.getDay();
        
        const statusElement = document.getElementById('marketStatus');
        const dot = statusElement.querySelector('div');
        const text = statusElement.querySelector('span');
        
        // å‘¨æœ«
        if (day === 0 || day === 6) {
            dot.className = 'w-2 h-2 rounded-full mr-2 bg-gray-400';
            text.textContent = 'ä¼‘å¸‚ä¸­';
            statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600';
        }
        // äº¤æ˜“æ—¶é—´
        else if ((time >= 915 && time <= 1130) || (time >= 1300 && time <= 1500)) {
            if (time >= 915 && time <= 925) {
                dot.className = 'w-2 h-2 rounded-full mr-2 bg-yellow-400 animate-pulse';
                text.textContent = 'é›†åˆç«ä»·';
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-600';
            } else {
                dot.className = 'w-2 h-2 rounded-full mr-2 bg-green-400 animate-pulse';
                text.textContent = 'äº¤æ˜“ä¸­';
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-600';
            }
        }
        // éäº¤æ˜“æ—¶é—´
        else {
            dot.className = 'w-2 h-2 rounded-full mr-2 bg-gray-400';
            text.textContent = 'é—­å¸‚ä¸­';
            statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600';
        }
    }
    
    // å¯åŠ¨/åœæ­¢è°ƒåº¦å™¨
    async function toggleScheduler() {
        const isRunning = {{ 'true' if system_status.scheduler_running else 'false' }};
        const endpoint = isRunning ? '/api/stop_scheduler' : '/api/start_scheduler';
        
        try {
            const response = await makeRequest(endpoint, 'POST');
            if (response.success) {
                showToast(response.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(response.message, 'error');
            }
        } catch (error) {
            showToast('æ“ä½œå¤±è´¥', 'error');
        }
    }
    
    // è¿è¡Œåˆ†æ
    async function runAnalysis() {
        showToast('å¼€å§‹æ‰§è¡Œè‚¡ç¥¨åˆ†æï¼Œè¯·ç¨å€™...', 'info');
        
        try {
            const response = await makeRequest('/api/run_analysis', 'POST');
            if (response.success) {
                showToast(response.message, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showToast(response.message, 'error');
            }
        } catch (error) {
            showToast('åˆ†æå¤±è´¥', 'error');
        }
    }
    
    // æµ‹è¯•é‚®ä»¶
    async function testEmail() {
        showToast('æ­£åœ¨å‘é€æµ‹è¯•é‚®ä»¶...', 'info');
        
        try {
            const response = await makeRequest('/api/test_email', 'POST');
            if (response.success) {
                showToast(response.message, 'success');
            } else {
                showToast(response.message, 'error');
            }
        } catch (error) {
            showToast('é‚®ä»¶æµ‹è¯•å¤±è´¥', 'error');
        }
    }
    
    // åˆ·æ–°çŠ¶æ€
    async function refreshStatus() {
        try {
            const response = await makeRequest('/api/system_status');
            if (response) {
                const lastUpdate = response.last_update;
                if (lastUpdate && lastUpdate !== "ä»æœªæ›´æ–°") {
                    document.getElementById('lastUpdateTime').textContent = lastUpdate.substring(0, 19);
                }
                showToast('çŠ¶æ€å·²åˆ·æ–°', 'success', 1000);
            }
        } catch (error) {
            showToast('åˆ·æ–°å¤±è´¥', 'error');
        }
    }
    
    // æ˜¾ç¤ºè‚¡ç¥¨è¯¦æƒ…
    function showStockDetail(symbol) {
        // è¿™é‡Œå¯ä»¥å®ç°è¯¦ç»†çš„è‚¡ç¥¨ä¿¡æ¯æ˜¾ç¤º
        const modal = document.getElementById('stockDetailModal');
        const content = document.getElementById('stockDetailContent');
        
        content.innerHTML = `
            <div class="animate-pulse">
                <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
                <div class="h-4 bg-gray-200 rounded w-5/6"></div>
            </div>
        `;
        
        modal.classList.remove('hidden');
        
        // è¿™é‡Œåº”è¯¥ä»APIè·å–è¯¦ç»†æ•°æ®
        setTimeout(() => {
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h4 class="text-lg font-semibold">${symbol} è¯¦ç»†åˆ†æ</h4>
                        <p class="text-gray-600 mt-2">æ›´å¤šè¯¦ç»†ä¿¡æ¯å³å°†æ¨å‡º...</p>
                    </div>
                </div>
            `;
        }, 500);
    }
    
    // å…³é—­è‚¡ç¥¨è¯¦æƒ…æ¨¡æ€æ¡†
    function closeStockDetailModal() {
        document.getElementById('stockDetailModal').classList.add('hidden');
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        updateClock();
        setInterval(updateClock, 1000);
        
        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
        setInterval(refreshStatus, 30000);
    });
</script>
{% endblock %}