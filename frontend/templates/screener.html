{% extends "base.html" %}

{% block title %}条件选股 - CChanTrader-AI 智能交易管理平台{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 页面标题 -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold tracking-tight">条件选股</h1>
            <p class="text-gray-600 mt-2">同花顺风格多维度条件选股，筛选结果自动保存</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- ===== 左侧：筛选条件面板 ===== -->
        <div class="lg:col-span-2 space-y-6">

            <!-- 快捷模板 -->
            <div class="card">
                <div class="p-4 border-b">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i data-lucide="layout-template" class="w-5 h-5 mr-2 text-blue-600"></i>
                        快捷选股模板
                    </h3>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        {% for preset in presets %}
                        <button
                            class="card hover-lift text-left p-4 cursor-pointer transition-all border-2 border-transparent hover:border-blue-400 preset-btn"
                            data-key="{{ preset.key }}"
                            onclick="applyPreset('{{ preset.key }}')"
                        >
                            <div class="font-semibold text-sm mb-1">{{ preset.name }}</div>
                            <p class="text-xs text-gray-500 leading-relaxed">{{ preset.description }}</p>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- 自定义条件 -->
            <div class="card">
                <div class="p-4 border-b flex items-center justify-between">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i data-lucide="sliders-horizontal" class="w-5 h-5 mr-2 text-purple-600"></i>
                        自定义筛选条件
                    </h3>
                    <button class="button button-sm button-ghost text-gray-500" onclick="resetConditions()">
                        <i data-lucide="rotate-ccw" class="w-4 h-4 mr-1"></i>重置
                    </button>
                </div>
                <div class="p-6 space-y-5">
                    <!-- 记录名称 -->
                    <div>
                        <label class="block text-sm font-medium mb-1">记录名称</label>
                        <input type="text" id="recordName" class="input" placeholder="给本次选股起个名字（可选）">
                    </div>

                    <!-- 价格区间 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">最低价格 (元)</label>
                            <input type="number" id="priceMin" class="input" step="0.1" placeholder="不限">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">最高价格 (元)</label>
                            <input type="number" id="priceMax" class="input" step="0.1" placeholder="不限">
                        </div>
                    </div>

                    <!-- 评分区间 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">综合评分 ≥</label>
                            <input type="number" id="totalScoreMin" class="input" step="0.01" min="0" max="1" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">技术评分 ≥</label>
                            <input type="number" id="techScoreMin" class="input" step="0.01" min="0" max="1" placeholder="0.00">
                        </div>
                    </div>

                    <!-- 竞价条件 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">竞价涨幅 ≥ (%)</label>
                            <input type="number" id="auctionRatioMin" class="input" step="0.1" placeholder="不限">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">竞价涨幅 ≤ (%)</label>
                            <input type="number" id="auctionRatioMax" class="input" step="0.1" placeholder="不限">
                        </div>
                    </div>

                    <!-- RSI -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">RSI ≥</label>
                            <input type="number" id="rsiMin" class="input" step="1" min="0" max="100" placeholder="不限">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">RSI ≤</label>
                            <input type="number" id="rsiMax" class="input" step="1" min="0" max="100" placeholder="不限">
                        </div>
                    </div>

                    <!-- 市值 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">市值 ≥ (亿)</label>
                            <input type="number" id="marketCapMin" class="input" step="1" placeholder="不限">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">市值 ≤ (亿)</label>
                            <input type="number" id="marketCapMax" class="input" step="1" placeholder="不限">
                        </div>
                    </div>

                    <!-- 跳空类型 -->
                    <div>
                        <label class="block text-sm font-medium mb-2">跳空类型</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="gap-type-chk rounded" value="gap_up"> <span>高开 ↑</span>
                            </label>
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="gap-type-chk rounded" value="flat"> <span>平开 →</span>
                            </label>
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="gap-type-chk rounded" value="gap_down"> <span>低开 ↓</span>
                            </label>
                        </div>
                    </div>

                    <!-- 信心等级 -->
                    <div>
                        <label class="block text-sm font-medium mb-2">信心等级</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="conf-chk rounded" value="very_high"> <span>非常高</span>
                            </label>
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="conf-chk rounded" value="high"> <span>高</span>
                            </label>
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="conf-chk rounded" value="medium"> <span>中等</span>
                            </label>
                        </div>
                    </div>

                    <!-- 市场板块 -->
                    <div>
                        <label class="block text-sm font-medium mb-2">市场板块</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="market-chk rounded" value="上海主板"> <span>上海主板</span>
                            </label>
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="market-chk rounded" value="深圳主板"> <span>深圳主板</span>
                            </label>
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="market-chk rounded" value="中小板"> <span>中小板</span>
                            </label>
                            <label class="inline-flex items-center space-x-1 text-sm cursor-pointer">
                                <input type="checkbox" class="market-chk rounded" value="创业板"> <span>创业板</span>
                            </label>
                        </div>
                    </div>

                    <!-- 关键词 -->
                    <div>
                        <label class="block text-sm font-medium mb-1">关键词搜索</label>
                        <input type="text" id="keyword" class="input" placeholder="股票代码或名称">
                    </div>

                    <!-- 手动输入自定义条件 -->
                    <div>
                        <label class="block text-sm font-medium mb-2 flex items-center">
                            <i data-lucide="pencil-line" class="w-4 h-4 mr-1 text-indigo-500"></i>
                            手动自定义条件
                            <span class="text-xs text-gray-400 ml-2">（可添加多条，所有条件同时满足才通过）</span>
                        </label>
                        <div id="customRulesContainer" class="space-y-2"></div>
                        <button type="button" class="button button-sm button-outline mt-2" onclick="addCustomRule()">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i>添加条件
                        </button>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex gap-3 pt-2">
                        <button id="runScreenerBtn" class="button button-primary flex-1" onclick="runScreener()">
                            <i data-lucide="search" class="w-4 h-4 mr-2"></i>开始选股
                        </button>
                    </div>
                </div>
            </div>

            <!-- ===== 筛选结果 ===== -->
            <div id="resultSection" class="card hidden">
                <div class="p-4 border-b flex items-center justify-between">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-green-600"></i>
                        筛选结果
                        <span id="resultCount" class="ml-2 badge badge-default">0</span>
                    </h3>
                    <span id="resultRecordId" class="text-xs text-gray-400"></span>
                </div>

                <!-- 结果统计 -->
                <div id="resultStats" class="p-4 border-b bg-gray-50">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center text-sm"></div>
                </div>

                <!-- 结果表格 -->
                <div class="overflow-x-auto">
                    <table class="w-full" id="resultTable">
                        <thead class="border-b bg-gray-50">
                            <tr class="text-left text-sm">
                                <th class="p-3 font-semibold">代码</th>
                                <th class="p-3 font-semibold">名称</th>
                                <th class="p-3 font-semibold">市场</th>
                                <th class="p-3 font-semibold">价格</th>
                                <th class="p-3 font-semibold">综合评分</th>
                                <th class="p-3 font-semibold">竞价涨幅</th>
                                <th class="p-3 font-semibold">信心</th>
                                <th class="p-3 font-semibold">策略</th>
                                <th class="p-3 font-semibold">操作</th>
                            </tr>
                        </thead>
                        <tbody id="resultTableBody"></tbody>
                    </table>
                </div>

                <div id="resultEmpty" class="hidden text-center py-10 text-gray-400">
                    <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-3"></i>
                    <p>没有符合条件的股票</p>
                </div>
            </div>
        </div>

        <!-- ===== 右侧：历史记录 ===== -->
        <div class="space-y-4">
            <div class="card">
                <div class="p-4 border-b">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i data-lucide="history" class="w-5 h-5 mr-2 text-amber-500"></i>
                        选股历史
                    </h3>
                </div>
                <div class="divide-y max-h-[70vh] overflow-y-auto" id="historyList">
                    {% if records %}
                        {% for rec in records %}
                        <div class="p-4 hover:bg-gray-50 transition-colors cursor-pointer group" onclick="loadRecord({{ rec.id }})">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-sm truncate">{{ rec.name }}</div>
                                    <div class="text-xs text-gray-500 mt-1">{{ rec.created_at }}</div>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="badge badge-secondary text-xs">{{ rec.result_count }} 只</span>
                                        {% if rec.preset_key %}
                                        <span class="badge badge-outline text-xs">{{ rec.preset_key }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <button class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"
                                        onclick="event.stopPropagation(); deleteRecord({{ rec.id }}, this)">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-8 text-center text-gray-400 text-sm" id="historyEmpty">
                            <i data-lucide="archive" class="w-10 h-10 mx-auto mb-2"></i>
                            <p>暂无选股记录</p>
                            <p class="mt-1 text-xs">执行一次选股后记录将自动保存</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const presetData = {{ presets | tojson }};

    /* ---------- 预置模板 ---------- */
    function applyPreset(key) {
        const tpl = presetData.find(p => p.key === key);
        if (!tpl) return;

        resetConditions();
        const c = tpl.conditions;

        if (c.price_min != null) document.getElementById('priceMin').value = c.price_min;
        if (c.price_max != null) document.getElementById('priceMax').value = c.price_max;
        if (c.total_score_min != null) document.getElementById('totalScoreMin').value = c.total_score_min;
        if (c.tech_score_min != null) document.getElementById('techScoreMin').value = c.tech_score_min;
        if (c.auction_ratio_min != null) document.getElementById('auctionRatioMin').value = c.auction_ratio_min;
        if (c.auction_ratio_max != null) document.getElementById('auctionRatioMax').value = c.auction_ratio_max;
        if (c.rsi_min != null) document.getElementById('rsiMin').value = c.rsi_min;
        if (c.rsi_max != null) document.getElementById('rsiMax').value = c.rsi_max;
        if (c.market_cap_min != null) document.getElementById('marketCapMin').value = c.market_cap_min;
        if (c.market_cap_max != null) document.getElementById('marketCapMax').value = c.market_cap_max;

        if (c.gap_types) {
            document.querySelectorAll('.gap-type-chk').forEach(chk => {
                chk.checked = c.gap_types.includes(chk.value);
            });
        }
        if (c.confidence_levels) {
            document.querySelectorAll('.conf-chk').forEach(chk => {
                chk.checked = c.confidence_levels.includes(chk.value);
            });
        }
        if (c.markets) {
            document.querySelectorAll('.market-chk').forEach(chk => {
                chk.checked = c.markets.includes(chk.value);
            });
        }

        document.getElementById('recordName').value = tpl.name;

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.classList.toggle('border-blue-500', btn.dataset.key === key);
            btn.classList.toggle('bg-blue-50', btn.dataset.key === key);
        });

        showNotification(`已加载模板「${tpl.name}」，点击"开始选股"执行`, 'default');
    }

    /* ---------- 手动自定义条件 ---------- */
    const FIELD_OPTIONS = [
        { value: 'current_price',      label: '当前价格' },
        { value: 'total_score',        label: '综合评分' },
        { value: 'tech_score',         label: '技术评分' },
        { value: 'auction_score',      label: '竞价评分' },
        { value: 'auction_ratio',      label: '竞价涨幅(%)' },
        { value: 'rsi',                label: 'RSI' },
        { value: 'market_cap_billion', label: '市值(亿)' },
        { value: 'entry_price',        label: '入场价' },
        { value: 'stop_loss',          label: '止损价' },
        { value: 'target_price',       label: '目标价' },
        { value: 'symbol',             label: '股票代码' },
        { value: 'stock_name',         label: '股票名称' },
        { value: 'market',             label: '市场' },
        { value: 'strategy',           label: '策略' },
    ];
    const OP_OPTIONS = [
        { value: 'gt',       label: '>' },
        { value: 'gte',      label: '≥' },
        { value: 'lt',       label: '<' },
        { value: 'lte',      label: '≤' },
        { value: 'eq',       label: '=' },
        { value: 'neq',      label: '≠' },
        { value: 'contains', label: '包含' },
    ];
    let ruleCounter = 0;

    function addCustomRule() {
        ruleCounter++;
        const id = ruleCounter;
        const fieldOpts = FIELD_OPTIONS.map(f => `<option value="${f.value}">${f.label}</option>`).join('');
        const opOpts = OP_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
        const html = `
            <div class="flex items-center gap-2 custom-rule" data-rule-id="${id}">
                <select class="select text-sm h-9 w-36 rule-field">${fieldOpts}</select>
                <select class="select text-sm h-9 w-20 rule-op">${opOpts}</select>
                <input type="text" class="input text-sm h-9 flex-1 rule-value" placeholder="值">
                <button type="button" class="text-gray-400 hover:text-red-500 p-1" onclick="this.closest('.custom-rule').remove()">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        `;
        document.getElementById('customRulesContainer').insertAdjacentHTML('beforeend', html);
        lucide.createIcons();
    }

    function gatherCustomRules() {
        const rules = [];
        document.querySelectorAll('.custom-rule').forEach(el => {
            const field = el.querySelector('.rule-field').value;
            const op = el.querySelector('.rule-op').value;
            const raw = el.querySelector('.rule-value').value.trim();
            if (field && op && raw !== '') {
                const numVal = Number(raw);
                rules.push({ field, op, value: isNaN(numVal) ? raw : numVal });
            }
        });
        return rules;
    }

    /* ---------- 收集条件 ---------- */
    function gatherConditions() {
        const cond = {};
        const v = id => { const el = document.getElementById(id); return el && el.value !== '' ? Number(el.value) : null; };

        if (v('priceMin') != null) cond.price_min = v('priceMin');
        if (v('priceMax') != null) cond.price_max = v('priceMax');
        if (v('totalScoreMin') != null) cond.total_score_min = v('totalScoreMin');
        if (v('techScoreMin') != null) cond.tech_score_min = v('techScoreMin');
        if (v('auctionRatioMin') != null) cond.auction_ratio_min = v('auctionRatioMin');
        if (v('auctionRatioMax') != null) cond.auction_ratio_max = v('auctionRatioMax');
        if (v('rsiMin') != null) cond.rsi_min = v('rsiMin');
        if (v('rsiMax') != null) cond.rsi_max = v('rsiMax');
        if (v('marketCapMin') != null) cond.market_cap_min = v('marketCapMin');
        if (v('marketCapMax') != null) cond.market_cap_max = v('marketCapMax');

        const gaps = [...document.querySelectorAll('.gap-type-chk:checked')].map(c => c.value);
        if (gaps.length) cond.gap_types = gaps;

        const confs = [...document.querySelectorAll('.conf-chk:checked')].map(c => c.value);
        if (confs.length) cond.confidence_levels = confs;

        const mkts = [...document.querySelectorAll('.market-chk:checked')].map(c => c.value);
        if (mkts.length) cond.markets = mkts;

        const kw = document.getElementById('keyword').value.trim();
        if (kw) cond.keyword = kw;

        const customRules = gatherCustomRules();
        if (customRules.length) cond.custom_rules = customRules;

        return cond;
    }

    /* ---------- 执行选股 ---------- */
    function runScreener() {
        const btn = document.getElementById('runScreenerBtn');
        const origHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>筛选中…';
        lucide.createIcons();

        const conditions = gatherConditions();
        const name = document.getElementById('recordName').value.trim();

        const selectedPreset = document.querySelector('.preset-btn.border-blue-500');
        const preset_key = selectedPreset ? selectedPreset.dataset.key : '';

        makeRequest('/api/screener/run', 'POST', { conditions, name, preset_key })
            .then(resp => {
                if (resp.success) {
                    showNotification(resp.message, 'default');
                    renderResults(resp.data);
                    refreshHistory();
                } else {
                    showNotification(resp.message, 'destructive');
                }
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = origHTML;
                lucide.createIcons();
            });
    }

    /* ---------- 渲染结果 ---------- */
    function renderResults(data) {
        const section = document.getElementById('resultSection');
        section.classList.remove('hidden');

        document.getElementById('resultCount').textContent = data.total;
        document.getElementById('resultRecordId').textContent = `#${data.record_id}`;

        const tbody = document.getElementById('resultTableBody');
        const empty = document.getElementById('resultEmpty');

        if (!data.stocks || data.stocks.length === 0) {
            tbody.innerHTML = '';
            empty.classList.remove('hidden');
            document.getElementById('resultStats').innerHTML = '';
            lucide.createIcons();
            return;
        }

        empty.classList.add('hidden');

        // 统计
        const stocks = data.stocks;
        const avgScore = (stocks.reduce((s, x) => s + (x.total_score || 0), 0) / stocks.length).toFixed(3);
        const highConf = stocks.filter(s => s.confidence === 'very_high').length;
        const markets = [...new Set(stocks.map(s => s.market))];
        const prices = stocks.map(s => s.current_price || 0);

        document.getElementById('resultStats').innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center text-sm">
                <div><div class="text-xl font-bold text-blue-600">${stocks.length}</div><div class="text-gray-500">筛选结果</div></div>
                <div><div class="text-xl font-bold text-green-600">${highConf}</div><div class="text-gray-500">强烈推荐</div></div>
                <div><div class="text-xl font-bold text-purple-600">${avgScore}</div><div class="text-gray-500">平均评分</div></div>
                <div><div class="text-xl font-bold text-orange-600">${markets.length}</div><div class="text-gray-500">覆盖市场</div></div>
                <div><div class="text-xl font-bold text-cyan-600">¥${Math.min(...prices).toFixed(0)}-${Math.max(...prices).toFixed(0)}</div><div class="text-gray-500">价格区间</div></div>
            </div>
        `;

        const confMap = { very_high: '非常高', high: '高', medium: '中等' };
        const confClass = { very_high: 'badge-default', high: 'badge-secondary', medium: 'badge-outline' };

        tbody.innerHTML = stocks.map(s => `
            <tr class="border-b hover:bg-gray-50 text-sm">
                <td class="p-3 font-mono">${s.symbol || ''}</td>
                <td class="p-3 font-medium">${s.stock_name || ''}</td>
                <td class="p-3"><span class="badge badge-secondary">${s.market || ''}</span></td>
                <td class="p-3 font-semibold">¥${(s.current_price || 0).toFixed(2)}</td>
                <td class="p-3"><span class="score">${(s.total_score || 0).toFixed(3)}</span></td>
                <td class="p-3"><span class="${(s.auction_ratio || 0) >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">${(s.auction_ratio || 0) >= 0 ? '+' : ''}${(s.auction_ratio || 0).toFixed(1)}%</span></td>
                <td class="p-3"><span class="badge ${confClass[s.confidence] || 'badge-outline'}">${confMap[s.confidence] || '中等'}</span></td>
                <td class="p-3 max-w-xs"><p class="text-xs text-gray-600 truncate">${s.strategy || ''}</p></td>
                <td class="p-3"><button class="button button-sm button-outline" onclick="window.location.href='/stock/${s.symbol}'">详情</button></td>
            </tr>
        `).join('');

        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        lucide.createIcons();
    }

    /* ---------- 历史记录 ---------- */
    function refreshHistory() {
        makeRequest('/api/screener/records?limit=20')
            .then(resp => {
                if (!resp.success) return;
                const list = document.getElementById('historyList');
                if (!resp.data || resp.data.length === 0) {
                    list.innerHTML = `<div class="p-8 text-center text-gray-400 text-sm">
                        <i data-lucide="archive" class="w-10 h-10 mx-auto mb-2"></i>
                        <p>暂无选股记录</p></div>`;
                    lucide.createIcons();
                    return;
                }

                list.innerHTML = resp.data.map(rec => `
                    <div class="p-4 hover:bg-gray-50 transition-colors cursor-pointer group" onclick="loadRecord(${rec.id})">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-sm truncate">${rec.name}</div>
                                <div class="text-xs text-gray-500 mt-1">${rec.created_at}</div>
                                <div class="flex items-center gap-2 mt-2">
                                    <span class="badge badge-secondary text-xs">${rec.result_count} 只</span>
                                    ${rec.preset_key ? `<span class="badge badge-outline text-xs">${rec.preset_key}</span>` : ''}
                                </div>
                            </div>
                            <button class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"
                                    onclick="event.stopPropagation(); deleteRecord(${rec.id}, this)">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            });
    }

    function loadRecord(id) {
        makeRequest(`/api/screener/records/${id}`)
            .then(resp => {
                if (!resp.success) { showNotification(resp.message, 'destructive'); return; }
                const rec = resp.data;
                const stocks = (rec.result_data && rec.result_data.length)
                    ? rec.result_data
                    : (rec.result_summary || {}).top_stocks || [];

                renderResults({
                    record_id: rec.id,
                    total: rec.result_count,
                    stocks: stocks,
                });

                showNotification(`已加载记录「${rec.name}」(${rec.result_count} 只)`, 'default');
            });
    }

    function deleteRecord(id, btnEl) {
        if (!confirm('确定删除这条记录？')) return;
        makeRequest(`/api/screener/records/${id}`, 'DELETE')
            .then(resp => {
                if (resp.success) {
                    showNotification('记录已删除', 'default');
                    const item = btnEl.closest('.group');
                    if (item) item.remove();
                } else {
                    showNotification(resp.message, 'destructive');
                }
            });
    }

    /* ---------- 重置条件 ---------- */
    function resetConditions() {
        ['priceMin','priceMax','totalScoreMin','techScoreMin',
         'auctionRatioMin','auctionRatioMax','rsiMin','rsiMax',
         'marketCapMin','marketCapMax','keyword','recordName'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        document.querySelectorAll('.gap-type-chk, .conf-chk, .market-chk').forEach(c => c.checked = false);
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.classList.remove('border-blue-500', 'bg-blue-50');
        });
        document.getElementById('customRulesContainer').innerHTML = '';
    }
</script>
{% endblock %}
