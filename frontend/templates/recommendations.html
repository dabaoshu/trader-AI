{% extends "base.html" %}

{% block title %}è‚¡ç¥¨æ¨è - æ™ºèƒ½é€‰è‚¡åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold tracking-tight">è‚¡ç¥¨æ¨èä¸­å¿ƒ</h1>
            <p class="text-gray-600 mt-2">åŸºäºæ™ºèƒ½ç®—æ³•çš„è‚¡ç¥¨æ¨èä¸åˆ†æ</p>
        </div>
        <div class="flex items-center space-x-3">
            <button class="button button-primary" onclick="runAnalysis()">
                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>åˆ·æ–°åˆ†æ
            </button>
            <div class="flex border rounded-lg p-1">
                <button class="px-3 py-1 rounded text-sm bg-blue-100 text-blue-700" onclick="switchView('table')" id="tableViewBtn">
                    <i data-lucide="table" class="w-4 h-4"></i>
                </button>
                <button class="px-3 py-1 rounded text-sm text-gray-600 hover:bg-gray-100" onclick="switchView('card')" id="cardViewBtn">
                    <i data-lucide="grid-3x3" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ç­›é€‰å·¥å…·æ  -->
    <div class="card">
        <div class="p-6 border-b">
            <h3 class="text-lg font-semibold mb-4">ç­›é€‰æ¡ä»¶</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">æ—¥æœŸç­›é€‰</label>
                    <input type="date" class="input" id="dateFilter" name="date" value="{{ current_date }}">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">å¸‚åœº</label>
                    <select class="select" id="marketFilter">
                        <option value="">å…¨éƒ¨å¸‚åœº</option>
                        <option value="ä¸Šæµ·ä¸»æ¿">ä¸Šæµ·ä¸»æ¿</option>
                        <option value="æ·±åœ³ä¸»æ¿">æ·±åœ³ä¸»æ¿</option>
                        <option value="ä¸­å°æ¿">ä¸­å°æ¿</option>
                        <option value="åˆ›ä¸šæ¿">åˆ›ä¸šæ¿</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">ä¿¡å¿ƒç­‰çº§</label>
                    <select class="select" id="confidenceFilter">
                        <option value="">å…¨éƒ¨ç­‰çº§</option>
                        <option value="very_high">éå¸¸é«˜</option>
                        <option value="high">é«˜</option>
                        <option value="medium">ä¸­ç­‰</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">æœç´¢è‚¡ç¥¨</label>
                    <input type="text" class="input" id="searchInput" placeholder="è‚¡ç¥¨ä»£ç æˆ–åç§°">
                </div>
                
                <div class="flex items-end space-x-2">
                    <button class="button button-outline" onclick="applyFilters()">
                        <i data-lucide="filter" class="w-4 h-4 mr-1"></i>ç­›é€‰
                    </button>
                    <button class="button button-ghost" onclick="clearFilters()">
                        <i data-lucide="x" class="w-4 h-4 mr-1"></i>æ¸…é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®ç»Ÿè®¡ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card p-6 text-center">
            <div class="text-3xl font-bold text-blue-600 mb-2" id="totalCount">{{ recommendations|length }}</div>
            <p class="text-sm text-gray-600">æ¨èæ€»æ•°</p>
        </div>
        <div class="card p-6 text-center">
            <div class="text-3xl font-bold text-green-600 mb-2" id="highConfidenceCount">
                {{ recommendations|selectattr("confidence", "equalto", "very_high")|list|length }}
            </div>
            <p class="text-sm text-gray-600">å¼ºçƒˆæ¨è</p>
        </div>
        <div class="card p-6 text-center">
            <div class="text-3xl font-bold text-purple-600 mb-2" id="avgScore">
                {% if recommendations %}
                    {{ "%.3f"|format(recommendations|map(attribute='total_score')|sum / recommendations|length) }}
                {% else %}
                    0.000
                {% endif %}
            </div>
            <p class="text-sm text-gray-600">å¹³å‡è¯„åˆ†</p>
        </div>
        <div class="card p-6 text-center">
            <div class="text-3xl font-bold text-orange-600 mb-2" id="marketCount">
                {{ recommendations|map(attribute='market')|unique|list|length }}
            </div>
            <p class="text-sm text-gray-600">è¦†ç›–å¸‚åœº</p>
        </div>
    </div>

    <!-- è¡¨æ ¼è§†å›¾ -->
    <div class="card" id="tableView">
        {% if recommendations %}
        <div class="overflow-x-auto">
            <table class="w-full" id="stockTable">
                <thead class="border-b">
                    <tr class="text-left">
                        <th class="p-4 font-semibold">è‚¡ç¥¨ä»£ç </th>
                        <th class="p-4 font-semibold">è‚¡ç¥¨åç§°</th>
                        <th class="p-4 font-semibold">å¸‚åœº</th>
                        <th class="p-4 font-semibold">å½“å‰ä»·æ ¼</th>
                        <th class="p-4 font-semibold">ç»¼åˆè¯„åˆ†</th>
                        <th class="p-4 font-semibold">ç«ä»·æ¯”ç‡</th>
                        <th class="p-4 font-semibold">ä¿¡å¿ƒç­‰çº§</th>
                        <th class="p-4 font-semibold">å»ºè®®ç­–ç•¥</th>
                        <th class="p-4 font-semibold">ç­–ç•¥è§£é‡Š</th>
                        <th class="p-4 font-semibold">çŠ¶æ€</th>
                        <th class="p-4 font-semibold">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in recommendations %}
                    <tr class="border-b hover:bg-gray-50" data-stock-id="{{ stock.id }}">
                        <td class="p-4">
                            <span class="font-mono text-sm">{{ stock.symbol }}</span>
                        </td>
                        <td class="p-4 font-medium">{{ stock.stock_name or 'æœªçŸ¥' }}</td>
                        <td class="p-4">
                            <span class="badge badge-secondary">{{ stock.market }}</span>
                        </td>
                        <td class="p-4">
                            <span class="price">Â¥{{ "%.2f"|format(stock.current_price) }}</span>
                        </td>
                        <td class="p-4">
                            <span class="score">{{ "%.3f"|format(stock.total_score) }}</span>
                        </td>
                        <td class="p-4">
                            <span class="{% if stock.auction_ratio > 0 %}text-green-600{% else %}text-red-600{% endif %} font-semibold">
                                {{ "%+.1f"|format(stock.auction_ratio) }}%
                            </span>
                        </td>
                        <td class="p-4">
                            <span class="badge {% if stock.confidence == 'very_high' %}badge-default{% elif stock.confidence == 'high' %}badge-secondary{% else %}badge-outline{% endif %}">
                                {% if stock.confidence == 'very_high' %}éå¸¸é«˜
                                {% elif stock.confidence == 'high' %}é«˜
                                {% else %}ä¸­ç­‰{% endif %}
                            </span>
                        </td>
                        <td class="p-4">
                            <p class="text-sm text-gray-600 max-w-xs">{{ stock.strategy }}</p>
                        </td>
                        <td class="p-4">
                            <div class="max-w-xs">
                                <p class="text-xs text-gray-500 truncate">{{ stock.explanation or 'æš‚æ— è§£é‡Š' }}</p>
                                <button 
                                    class="text-indigo-600 hover:text-indigo-800 underline text-xs mt-1 transition-colors" 
                                    onclick="openStockModal('{{ stock.symbol }}')"
                                >æŸ¥çœ‹</button>
                            </div>
                        </td>
                        <td class="p-4">
                            <select class="select text-sm py-1 px-2 h-8" onchange="updateStockStatus({{ stock.id }}, this.value)">
                                <option value="pending" {% if stock.status == 'pending' %}selected{% endif %}>å¾…å†³ç­–</option>
                                <option value="bought" {% if stock.status == 'bought' %}selected{% endif %}>å·²ä¹°å…¥</option>
                                <option value="watching" {% if stock.status == 'watching' %}selected{% endif %}>è§‚å¯Ÿä¸­</option>
                                <option value="ignored" {% if stock.status == 'ignored' %}selected{% endif %}>å·²å¿½ç•¥</option>
                            </select>
                        </td>
                        <td class="p-4">
                            <button class="button button-sm button-outline" onclick="showStockDetail('{{ stock.symbol }}')">
                                è¯¦æƒ…
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <i data-lucide="search" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
            <h6 class="text-gray-600 font-semibold mb-2">æš‚æ— æ¨èæ•°æ®</h6>
            <p class="text-gray-500 mb-4">é€‰æ‹©æ—¥æœŸæˆ–ç‚¹å‡»"åˆ·æ–°åˆ†æ"è·å–æœ€æ–°æ¨è</p>
            <button class="button button-primary" onclick="runAnalysis()">
                <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i>å¼€å§‹åˆ†æ
            </button>
        </div>
        {% endif %}
    </div>

    <!-- å¡ç‰‡è§†å›¾ -->
    <div class="hidden" id="cardView">
        {% if recommendations %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="stockCards">
            {% for stock in recommendations %}
            <div class="card stock-card {% if stock.confidence == 'very_high' %}high-confidence{% elif stock.confidence == 'high' %}medium-confidence{% endif %} hover-lift">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h6 class="font-semibold text-lg">{{ stock.symbol }}</h6>
                            <p class="text-sm text-gray-600">{{ stock.stock_name or 'æœªçŸ¥è‚¡ç¥¨' }}</p>
                        </div>
                        <span class="score">{{ "%.3f"|format(stock.total_score) }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="price">Â¥{{ "%.2f"|format(stock.current_price) }}</div>
                        <span class="badge badge-secondary">{{ stock.market }}</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 text-center text-sm mb-4">
                        <div>
                            <p class="text-gray-600 text-xs mb-1">ç«ä»·</p>
                            <p class="{% if stock.auction_ratio > 0 %}text-green-600{% else %}text-red-600{% endif %} font-semibold">
                                {{ "%+.1f"|format(stock.auction_ratio) }}%
                            </p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-xs mb-1">ç›®æ ‡</p>
                            <p class="text-green-600 font-semibold">Â¥{{ "%.2f"|format(stock.target_price) }}</p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-xs mb-1">æ­¢æŸ</p>
                            <p class="text-red-600 font-semibold">Â¥{{ "%.2f"|format(stock.stop_loss) }}</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-xs text-gray-600">{{ stock.strategy }}</p>
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="button button-sm button-outline flex-1" onclick="showStockDetail('{{ stock.symbol }}')">
                            è¯¦æƒ…
                        </button>
                        <select class="select text-xs py-1 px-2 w-24" onchange="updateStockStatus({{ stock.id }}, this.value)">
                            <option value="pending" {% if stock.status == 'pending' %}selected{% endif %}>å¾…å†³ç­–</option>
                            <option value="bought" {% if stock.status == 'bought' %}selected{% endif %}>å·²ä¹°å…¥</option>
                            <option value="watching" {% if stock.status == 'watching' %}selected{% endif %}>è§‚å¯Ÿ</option>
                            <option value="ignored" {% if stock.status == 'ignored' %}selected{% endif %}>å¿½ç•¥</option>
                        </select>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- è‚¡ç¥¨è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="stockDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-4xl mx-4 max-h-screen overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b">
            <h3 class="text-xl font-semibold">è‚¡ç¥¨è¯¦ç»†åˆ†æ</h3>
            <button class="text-gray-400 hover:text-gray-600" onclick="closeStockDetailModal()">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="p-6" id="stockDetailContent">
            <!-- è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
        <div class="flex justify-end space-x-3 p-6 border-t">
            <button class="button button-outline" onclick="closeStockDetailModal()">å…³é—­</button>
            <button class="button button-primary">åŠ å…¥è‡ªé€‰</button>
        </div>
    </div>
</div>

<!-- >>> CChanTrader-AI Explain Patch : ç­–ç•¥è§£é‡Šæ¨¡æ€æ¡† -->
<div id="explanationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg w-full max-w-3xl mx-4 max-h-screen overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b">
            <div>
                <h3 class="text-xl font-semibold" id="explanationModalTitle">ç­–ç•¥è§£é‡Š</h3>
                <p class="text-sm text-gray-600 mt-1" id="explanationModalSubtitle">è¯¦ç»†æŠ•èµ„åˆ†æ</p>
            </div>
            <button class="text-gray-400 hover:text-gray-600" onclick="closeExplanationModal()">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="p-6" id="explanationModalContent">
            <!-- ç­–ç•¥è§£é‡Šå†…å®¹ -->
            <div class="space-y-6">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-blue-900 mb-2">ğŸ“Š åŸºæœ¬ä¿¡æ¯</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="text-gray-600">è‚¡ç¥¨ä»£ç ï¼š</span><span class="font-mono" id="exp_symbol">-</span></div>
                        <div><span class="text-gray-600">å½“å‰ä»·æ ¼ï¼š</span><span class="font-semibold" id="exp_price">-</span></div>
                        <div><span class="text-gray-600">ä¿¡å¿ƒç­‰çº§ï¼š</span><span class="badge" id="exp_confidence">-</span></div>
                        <div><span class="text-gray-600">ç»¼åˆè¯„åˆ†ï¼š</span><span class="font-semibold" id="exp_score">-</span></div>
                    </div>
                </div>
                
                <!-- æ¨èç†ç”± -->
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-green-900 mb-2">ğŸ¯ æ¨èç†ç”±</h4>
                    <p class="text-gray-700" id="exp_reason">åŠ è½½ä¸­...</p>
                </div>
                
                <!-- ä¹°å–ç­–ç•¥ -->
                <div class="bg-orange-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-orange-900 mb-2">ğŸ“ˆ ä¹°å–ç­–ç•¥</h4>
                    <div class="space-y-3 text-sm">
                        <div>
                            <span class="font-semibold text-green-600">ä¹°å…¥å»ºè®®ï¼š</span>
                            <p class="text-gray-700 mt-1" id="exp_buy_point">-</p>
                        </div>
                        <div>
                            <span class="font-semibold text-red-600">å–å‡ºç­–ç•¥ï¼š</span>
                            <p class="text-gray-700 mt-1" id="exp_sell_logic">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- é£é™©æ”¶ç›Š -->
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-purple-900 mb-2">âš–ï¸ é£é™©æ”¶ç›Šåˆ†æ</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="text-gray-600">å…¥åœºä»·ä½ï¼š</span><span class="font-semibold" id="exp_entry">-</span></div>
                        <div><span class="text-gray-600">æ­¢æŸä»·ä½ï¼š</span><span class="font-semibold text-red-600" id="exp_stop_loss">-</span></div>
                        <div><span class="text-gray-600">ç›®æ ‡åŒºé—´ï¼š</span><span class="font-semibold text-green-600" id="exp_target">-</span></div>
                        <div><span class="text-gray-600">é£é™©æ”¶ç›Šæ¯”ï¼š</span><span class="font-semibold" id="exp_rr">-</span></div>
                    </div>
                    <div class="mt-3">
                        <p class="text-gray-700 text-sm" id="exp_risk_analysis">-</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-end space-x-3 p-6 border-t">
            <button class="button button-outline" onclick="closeExplanationModal()">å…³é—­</button>
            <button class="button button-primary" onclick="addToWatchlist()">åŠ å…¥è‡ªé€‰</button>
        </div>
    </div>
</div>

{# === ä¼˜åŒ–ç‰ˆç»ç’ƒå¡ç‰‡ Modal ç»„ä»¶ === #}
<div id="pickModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <!-- èƒŒæ™¯é®ç½© -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"
         onclick="closeStockModal()"></div>

    <!-- æ¨¡æ€æ¡†å†…å®¹ - æ›´æ–°æ ·å¼ä¸º bg-white/95 + rounded-3xl + drop-shadow-xl -->
    <div class="relative w-full max-w-4xl max-h-[90vh] mx-4 bg-white/95 backdrop-blur-lg rounded-3xl drop-shadow-xl border border-white/30 overflow-hidden">
        <!-- å…³é—­æŒ‰é’® -->
        <button class="absolute top-6 right-6 text-gray-400 hover:text-gray-700 text-2xl z-10 w-10 h-10 flex items-center justify-center rounded-full bg-white/70 hover:bg-white/90 transition-all shadow-lg"
                onclick="closeStockModal()">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        
        <!-- æ¨¡æ€æ¡†ä¸»ä½“ -->
        <div id="pickModalBody" class="p-8 max-h-[80vh] overflow-y-auto text-sm text-gray-700">
            <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
            <div id="modalSkeleton" class="space-y-6 animate-pulse">
                <!-- æ ‡é¢˜éª¨æ¶ -->
                <div class="flex items-center justify-between">
                    <div class="space-y-2">
                        <div class="h-6 bg-gray-200 rounded w-32"></div>
                        <div class="h-4 bg-gray-200 rounded w-24"></div>
                    </div>
                    <div class="h-8 bg-gray-200 rounded w-20"></div>
                </div>
                
                <!-- å¡ç‰‡éª¨æ¶ -->
                <div class="bg-gray-50 p-6 rounded-xl">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="h-6 bg-gray-200 rounded mb-2"></div>
                            <div class="h-4 bg-gray-200 rounded w-12 mx-auto"></div>
                        </div>
                        <div class="text-center">
                            <div class="h-6 bg-gray-200 rounded mb-2"></div>
                            <div class="h-4 bg-gray-200 rounded w-12 mx-auto"></div>
                        </div>
                        <div class="text-center">
                            <div class="h-6 bg-gray-200 rounded mb-2"></div>
                            <div class="h-4 bg-gray-200 rounded w-12 mx-auto"></div>
                        </div>
                    </div>
                </div>
                
                <!-- å†…å®¹éª¨æ¶ -->
                <div class="space-y-4">
                    <div class="bg-white p-5 rounded-xl">
                        <div class="h-5 bg-gray-200 rounded w-20 mb-3"></div>
                        <div class="space-y-2">
                            <div class="h-4 bg-gray-200 rounded"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-xl">
                        <div class="h-5 bg-gray-200 rounded w-24 mb-3"></div>
                        <div class="space-y-2">
                            <div class="h-4 bg-gray-200 rounded"></div>
                            <div class="h-4 bg-gray-200 rounded w-4/6"></div>
                        </div>
                    </div>
                    
                    <!-- å›¾è¡¨éª¨æ¶ -->
                    <div class="bg-white p-5 rounded-xl">
                        <div class="h-5 bg-gray-200 rounded w-16 mb-3"></div>
                        <div class="h-32 bg-gray-200 rounded"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentView = 'table';
    let allStocks = {{ recommendations|tojson }};
    let filteredStocks = [...allStocks];
    
    // åˆ‡æ¢è§†å›¾
    function switchView(view) {
        currentView = view;
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const tableBtn = document.getElementById('tableViewBtn');
        const cardBtn = document.getElementById('cardViewBtn');
        
        if (view === 'table') {
            tableBtn.className = 'px-3 py-1 rounded text-sm bg-blue-100 text-blue-700';
            cardBtn.className = 'px-3 py-1 rounded text-sm text-gray-600 hover:bg-gray-100';
            document.getElementById('tableView').classList.remove('hidden');
            document.getElementById('cardView').classList.add('hidden');
        } else {
            tableBtn.className = 'px-3 py-1 rounded text-sm text-gray-600 hover:bg-gray-100';
            cardBtn.className = 'px-3 py-1 rounded text-sm bg-blue-100 text-blue-700';
            document.getElementById('tableView').classList.add('hidden');
            document.getElementById('cardView').classList.remove('hidden');
        }
    }
    
    // åº”ç”¨ç­›é€‰
    function applyFilters() {
        const market = document.getElementById('marketFilter').value;
        const confidence = document.getElementById('confidenceFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        const date = document.getElementById('dateFilter').value;
        
        // å¦‚æœæ—¥æœŸæ”¹å˜ï¼Œé‡æ–°åŠ è½½æ•°æ®
        if (date !== '{{ current_date }}') {
            window.location.href = `{{ url_for('recommendations') }}?date=${date}`;
            return;
        }
        
        filteredStocks = allStocks.filter(stock => {
            let match = true;
            
            if (market && stock.market !== market) match = false;
            if (confidence && stock.confidence !== confidence) match = false;
            if (search && !stock.symbol.toLowerCase().includes(search) && 
                !stock.stock_name.toLowerCase().includes(search)) match = false;
            
            return match;
        });
        
        updateDisplay();
        updateStats();
    }
    
    // æ¸…é™¤ç­›é€‰
    function clearFilters() {
        document.getElementById('marketFilter').value = '';
        document.getElementById('confidenceFilter').value = '';
        document.getElementById('searchInput').value = '';
        
        filteredStocks = [...allStocks];
        updateDisplay();
        updateStats();
    }
    
    // æ›´æ–°æ˜¾ç¤º
    function updateDisplay() {
        if (currentView === 'table') {
            updateTableDisplay();
        } else {
            updateCardDisplay();
        }
    }
    
    // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
    function updateTableDisplay() {
        const tbody = document.querySelector('#stockTable tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        filteredStocks.forEach(stock => {
            const row = createTableRow(stock);
            tbody.appendChild(row);
        });
    }
    
    // æ›´æ–°å¡ç‰‡æ˜¾ç¤º
    function updateCardDisplay() {
        const container = document.getElementById('stockCards');
        if (!container) return;
        
        container.innerHTML = '';
        
        filteredStocks.forEach(stock => {
            const card = createStockCard(stock);
            container.appendChild(card);
        });
    }
    
    // åˆ›å»ºè¡¨æ ¼è¡Œ
    function createTableRow(stock) {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';
        row.dataset.stockId = stock.id;
        
        const confidenceMap = {
            'very_high': { text: 'éå¸¸é«˜', class: 'badge-default' },
            'high': { text: 'é«˜', class: 'badge-secondary' },
            'medium': { text: 'ä¸­ç­‰', class: 'badge-outline' }
        };
        
        const confidence = confidenceMap[stock.confidence] || { text: 'ä¸­ç­‰', class: 'badge-outline' };
        
        row.innerHTML = `
            <td class="p-4"><span class="font-mono text-sm">${stock.symbol}</span></td>
            <td class="p-4 font-medium">${stock.stock_name || 'æœªçŸ¥'}</td>
            <td class="p-4"><span class="badge badge-secondary">${stock.market}</span></td>
            <td class="p-4"><span class="price">Â¥${stock.current_price.toFixed(2)}</span></td>
            <td class="p-4"><span class="score">${stock.total_score.toFixed(3)}</span></td>
            <td class="p-4"><span class="${stock.auction_ratio > 0 ? 'text-green-600' : 'text-red-600'} font-semibold">${stock.auction_ratio > 0 ? '+' : ''}${stock.auction_ratio.toFixed(1)}%</span></td>
            <td class="p-4"><span class="badge ${confidence.class}">${confidence.text}</span></td>
            <td class="p-4"><p class="text-sm text-gray-600 max-w-xs">${stock.strategy}</p></td>
            <td class="p-4">
                <select class="select text-sm py-1 px-2 h-8" onchange="updateStockStatus(${stock.id}, this.value)">
                    <option value="pending" ${stock.status === 'pending' ? 'selected' : ''}>å¾…å†³ç­–</option>
                    <option value="bought" ${stock.status === 'bought' ? 'selected' : ''}>å·²ä¹°å…¥</option>
                    <option value="watching" ${stock.status === 'watching' ? 'selected' : ''}>è§‚å¯Ÿä¸­</option>
                    <option value="ignored" ${stock.status === 'ignored' ? 'selected' : ''}>å·²å¿½ç•¥</option>
                </select>
            </td>
            <td class="p-4">
                <button class="button button-sm button-outline" onclick="showStockDetail('${stock.symbol}')">è¯¦æƒ…</button>
            </td>
        `;
        
        return row;
    }
    
    // åˆ›å»ºè‚¡ç¥¨å¡ç‰‡
    function createStockCard(stock) {
        const div = document.createElement('div');
        
        const confidenceClass = stock.confidence === 'very_high' ? 'high-confidence' : 
                               stock.confidence === 'high' ? 'medium-confidence' : '';
        
        div.innerHTML = `
            <div class="card stock-card ${confidenceClass} hover-lift">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h6 class="font-semibold text-lg">${stock.symbol}</h6>
                            <p class="text-sm text-gray-600">${stock.stock_name || 'æœªçŸ¥è‚¡ç¥¨'}</p>
                        </div>
                        <span class="score">${stock.total_score.toFixed(3)}</span>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="price">Â¥${stock.current_price.toFixed(2)}</div>
                        <span class="badge badge-secondary">${stock.market}</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 text-center text-sm mb-4">
                        <div>
                            <p class="text-gray-600 text-xs mb-1">ç«ä»·</p>
                            <p class="${stock.auction_ratio > 0 ? 'text-green-600' : 'text-red-600'} font-semibold">
                                ${stock.auction_ratio > 0 ? '+' : ''}${stock.auction_ratio.toFixed(1)}%
                            </p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-xs mb-1">ç›®æ ‡</p>
                            <p class="text-green-600 font-semibold">Â¥${stock.target_price.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-gray-600 text-xs mb-1">æ­¢æŸ</p>
                            <p class="text-red-600 font-semibold">Â¥${stock.stop_loss.toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-xs text-gray-600">${stock.strategy}</p>
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="button button-sm button-outline flex-1" onclick="showStockDetail('${stock.symbol}')">è¯¦æƒ…</button>
                        <select class="select text-xs py-1 px-2 w-24" onchange="updateStockStatus(${stock.id}, this.value)">
                            <option value="pending" ${stock.status === 'pending' ? 'selected' : ''}>å¾…å†³ç­–</option>
                            <option value="bought" ${stock.status === 'bought' ? 'selected' : ''}>å·²ä¹°å…¥</option>
                            <option value="watching" ${stock.status === 'watching' ? 'selected' : ''}>è§‚å¯Ÿ</option>
                            <option value="ignored" ${stock.status === 'ignored' ? 'selected' : ''}>å¿½ç•¥</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
        
        return div;
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
        document.getElementById('totalCount').textContent = filteredStocks.length;
        document.getElementById('highConfidenceCount').textContent = 
            filteredStocks.filter(s => s.confidence === 'very_high').length;
        
        const avgScore = filteredStocks.length > 0 ? 
            filteredStocks.reduce((sum, s) => sum + s.total_score, 0) / filteredStocks.length : 0;
        document.getElementById('avgScore').textContent = avgScore.toFixed(3);
        
        const markets = [...new Set(filteredStocks.map(s => s.market))];
        document.getElementById('marketCount').textContent = markets.length;
    }
    
    // æ›´æ–°è‚¡ç¥¨çŠ¶æ€
    function updateStockStatus(stockId, newStatus) {
        makeRequest('/api/update_stock_status', 'POST', {
            id: stockId,
            status: newStatus
        }).then(response => {
            if (response.success) {
                showNotification('çŠ¶æ€å·²æ›´æ–°', 'default');
                // æ›´æ–°æœ¬åœ°æ•°æ®
                const stock = allStocks.find(s => s.id === stockId);
                if (stock) {
                    stock.status = newStatus;
                }
            } else {
                showNotification(response.message, 'destructive');
            }
        });
    }
    
    // æ˜¾ç¤ºè‚¡ç¥¨è¯¦æƒ… - è·³è½¬åˆ°è¯¦æƒ…é¡µé¢
    function showStockDetail(symbol) {
        // è·³è½¬åˆ°è‚¡ç¥¨è¯¦æƒ…é¡µé¢ï¼Œè¿›è¡Œæ·±åº¦åˆ†æ
        window.location.href = `/stock/${symbol}`;
    }
    
    // å…³é—­è‚¡ç¥¨è¯¦æƒ…æ¨¡æ€æ¡†
    function closeStockDetailModal() {
        document.getElementById('stockDetailModal').classList.add('hidden');
    }
    
    // >>> CChanTrader-AI Explain Patch : ç­–ç•¥è§£é‡Šæ¨¡æ€æ¡†å‡½æ•°
    // æ˜¾ç¤ºç­–ç•¥è§£é‡Šæ¨¡æ€æ¡†
    function showExplanationModal(symbol, stockName, stockData) {
        try {
            // è®¾ç½®æ ‡é¢˜
            document.getElementById('explanationModalTitle').textContent = `${symbol} ç­–ç•¥è§£é‡Š`;
            document.getElementById('explanationModalSubtitle').textContent = `${stockName} - è¯¦ç»†æŠ•èµ„åˆ†æ`;
            
            // å¡«å……åŸºæœ¬ä¿¡æ¯
            document.getElementById('exp_symbol').textContent = symbol;
            document.getElementById('exp_price').textContent = `Â¥${stockData.current_price.toFixed(2)}`;
            
            const confidenceMap = {
                'very_high': 'éå¸¸é«˜',
                'high': 'é«˜',
                'medium': 'ä¸­ç­‰'
            };
            document.getElementById('exp_confidence').textContent = confidenceMap[stockData.confidence] || 'ä¸­ç­‰';
            document.getElementById('exp_score').textContent = stockData.total_score.toFixed(3);
            
            // å¡«å……æ¨èç†ç”±
            document.getElementById('exp_reason').textContent = stockData.explanation || 'æŠ€æœ¯é¢è¡¨ç°è‰¯å¥½ï¼Œå…·å¤‡æŠ•èµ„ä»·å€¼ã€‚';
            
            // å¡«å……ä¹°å–ç­–ç•¥
            document.getElementById('exp_buy_point').textContent = stockData.buy_point_explanation || 
                `å»ºè®®åœ¨${stockData.current_price.toFixed(2)}å…ƒé™„è¿‘ä¹°å…¥ï¼Œç­‰å¾…æŠ€æœ¯ä¿¡å·ç¡®è®¤ã€‚`;
            
            document.getElementById('exp_sell_logic').textContent = stockData.sell_logic || 
                'è¾¾åˆ°ç›®æ ‡ä»·ä½æ—¶åˆ†æ‰¹æ­¢ç›ˆï¼Œè·Œç ´æ­¢æŸä½åšå†³å‡ºå±€ã€‚';
            
            // å¡«å……é£é™©æ”¶ç›Šä¿¡æ¯
            document.getElementById('exp_entry').textContent = `Â¥${stockData.current_price.toFixed(2)}`;
            document.getElementById('exp_stop_loss').textContent = `Â¥${stockData.stop_loss.toFixed(2)}`;
            
            const targetRange = stockData.target_range || [0, 0];
            if (targetRange[0] > 0 && targetRange[1] > 0) {
                document.getElementById('exp_target').textContent = `Â¥${targetRange[0].toFixed(2)} - Â¥${targetRange[1].toFixed(2)}`;
            } else {
                const target = stockData.current_price * 1.1;
                document.getElementById('exp_target').textContent = `Â¥${target.toFixed(2)}`;
            }
            
            document.getElementById('exp_rr').textContent = stockData.expected_rr || '1.5';
            
            document.getElementById('exp_risk_analysis').textContent = stockData.risk_reward_analysis || 
                'è¯·æ ¹æ®ä¸ªäººé£é™©åå¥½è°¨æ…æ“ä½œï¼Œä¸¥æ ¼æ‰§è¡Œæ­¢æŸç­–ç•¥ã€‚';
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('explanationModal').classList.remove('hidden');
            
        } catch (error) {
            console.error('æ˜¾ç¤ºç­–ç•¥è§£é‡Šå¤±è´¥:', error);
            showNotification('åŠ è½½ç­–ç•¥è§£é‡Šå¤±è´¥', 'destructive');
        }
    }
    
    // å…³é—­ç­–ç•¥è§£é‡Šæ¨¡æ€æ¡†
    function closeExplanationModal() {
        document.getElementById('explanationModal').classList.add('hidden');
    }
    
    // åŠ å…¥è‡ªé€‰è‚¡
    function addToWatchlist() {
        showNotification('è‡ªé€‰è‚¡åŠŸèƒ½å¼€å‘ä¸­...', 'default');
        closeExplanationModal();
    }
    
    // è¿è¡Œåˆ†æ
    function runAnalysis() {
        showNotification('å¼€å§‹æ‰§è¡Œè‚¡ç¥¨åˆ†æï¼Œè¯·ç¨å€™...', 'default');
        
        makeRequest('/api/run_analysis', 'POST')
            .then(response => {
                if (response.success) {
                    showNotification(response.message, 'default');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showNotification(response.message, 'destructive');
                }
            });
    }
    
    // äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('dateFilter').addEventListener('change', function() {
        const newDate = this.value;
        window.location.href = `{{ url_for('recommendations') }}?date=${newDate}`;
    });
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('stockDetailModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeStockDetailModal();
        }
    });
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        updateStats();
        lucide.createIcons();
    });
</script>
{% endblock %}