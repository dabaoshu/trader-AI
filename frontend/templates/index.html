{% extends "base.html" %}

{% block title %}é¦–é¡µ - CChanTrader-AI æ™ºèƒ½äº¤æ˜“ç®¡ç†å¹³å°{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- ç³»ç»ŸçŠ¶æ€é¢æ¿ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ -->
        <div class="card p-6 text-center hover-lift">
            <div class="{% if system_status.scheduler_running %}status-running{% else %}status-stopped{% endif %} mb-4">
                <i data-lucide="{% if system_status.scheduler_running %}play-circle{% else %}stop-circle{% endif %}" class="w-10 h-10 mx-auto"></i>
            </div>
            <h6 class="font-semibold mb-2">è°ƒåº¦ç³»ç»Ÿ</h6>
            <p class="text-sm mb-2">
                {% if system_status.scheduler_running %}
                    <span class="text-green-600">è‡ªåŠ¨è¿è¡Œä¸­</span>
                {% else %}
                    <span class="text-red-600">æ‰‹åŠ¨æ¨¡å¼</span>
                {% endif %}
            </p>
            {% if system_status.scheduler_recommended and not system_status.scheduler_running %}
            <p class="text-xs text-blue-600 mb-3">ğŸ’¡ å»ºè®®å¯åŠ¨è°ƒåº¦å™¨</p>
            {% endif %}
            <button class="button button-sm {% if system_status.scheduler_running %}button-destructive{% else %}button-primary{% endif %}" 
                    onclick="toggleScheduler()">
                {% if system_status.scheduler_running %}åœæ­¢è°ƒåº¦{% else %}å¯åŠ¨è°ƒåº¦{% endif %}
            </button>
            {% if not system_status.scheduler_running %}
            <p class="text-xs text-gray-500 mt-2">æ‰‹åŠ¨æ§åˆ¶ï¼Œé¿å…æ„å¤–æ‰§è¡Œ</p>
            {% endif %}
        </div>
        
        <!-- ä»Šæ—¥æ¨è -->
        <div class="card p-6 text-center hover-lift">
            <div class="status-running mb-4">
                <i data-lucide="star" class="w-10 h-10 mx-auto"></i>
            </div>
            <h6 class="font-semibold mb-2">ä»Šæ—¥æ¨è</h6>
            <p class="text-sm mb-4">
                <span class="text-2xl font-bold text-blue-600">{{ system_status.today_recommendations }}</span> åªè‚¡ç¥¨
            </p>
            <button class="button button-sm button-primary" onclick="runAnalysis()">
                ç«‹å³åˆ†æ
            </button>
        </div>
        
        <!-- é‚®ä»¶çŠ¶æ€ -->
        <div class="card p-6 text-center hover-lift">
            <div class="{% if system_status.email_configured %}status-running{% else %}status-warning{% endif %} mb-4">
                <i data-lucide="mail" class="w-10 h-10 mx-auto"></i>
            </div>
            <h6 class="font-semibold mb-2">é‚®ä»¶é…ç½®</h6>
            <p class="text-sm mb-4">
                {% if system_status.email_configured %}
                    <span class="text-green-600">å·²é…ç½®</span>
                {% else %}
                    <span class="text-yellow-600">æœªé…ç½®</span>
                {% endif %}
            </p>
            <a href="{{ url_for('config') }}" class="button button-sm button-outline">
                è®¾ç½®é‚®ç®±
            </a>
        </div>
        
        <!-- æœ€åæ›´æ–° -->
        <div class="card p-6 text-center hover-lift">
            <div class="status-running mb-4">
                <i data-lucide="refresh-cw" class="w-10 h-10 mx-auto"></i>
            </div>
            <h6 class="font-semibold mb-2">æœ€åæ›´æ–°</h6>
            <p class="text-sm mb-4 text-gray-600">{{ system_status.last_update }}</p>
            <button class="button button-sm button-outline" onclick="refreshStatus()">
                åˆ·æ–°çŠ¶æ€
            </button>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- ä»Šæ—¥é‡ç‚¹æ¨è -->
        <div class="lg:col-span-2">
            <div class="card">
                <div class="flex items-center justify-between p-6 border-b">
                    <h5 class="text-lg font-semibold flex items-center">
                        <i data-lucide="trophy" class="w-5 h-5 text-yellow-500 mr-2"></i>
                        ä»Šæ—¥é‡ç‚¹æ¨è
                    </h5>
                    <a href="{{ url_for('recommendations') }}" class="button button-sm button-outline">
                        æŸ¥çœ‹å…¨éƒ¨ <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                    </a>
                </div>
                <div class="p-6">
                    {% if recommendations %}
                        <!-- é€‰è‚¡ç»“æœç»Ÿè®¡ -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">{{ recommendations|length }}</div>
                                <div class="text-xs text-gray-600">æ€»æ¨èæ•°</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600">{{ recommendations|selectattr("confidence", "equalto", "very_high")|list|length }}</div>
                                <div class="text-xs text-gray-600">å¼ºçƒˆæ¨è</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-600">
                                    {{ "%.3f"|format(recommendations|map(attribute='total_score')|sum / recommendations|length) }}
                                </div>
                                <div class="text-xs text-gray-600">å¹³å‡è¯„åˆ†</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600">{{ recommendations|map(attribute='market')|unique|list|length }}</div>
                                <div class="text-xs text-gray-600">æ¶‰åŠæ¿å—</div>
                            </div>
                        </div>

                        <!-- ä¼˜å…ˆçº§åˆ†ç»„æ˜¾ç¤º -->
                        {% set very_high_stocks = recommendations|selectattr("confidence", "equalto", "very_high")|list %}
                        {% set high_stocks = recommendations|selectattr("confidence", "equalto", "high")|list %}
                        {% set medium_stocks = recommendations|selectattr("confidence", "equalto", "medium")|list %}

                        {% if very_high_stocks %}
                        <div class="mb-6">
                            <div class="flex items-center mb-3">
                                <i data-lucide="star" class="w-5 h-5 text-yellow-500 mr-2"></i>
                                <h3 class="text-lg font-semibold text-green-600">é‡ç‚¹å…³æ³¨ ({{ very_high_stocks|length }}åª)</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {% for stock in very_high_stocks %}
                                <div class="card stock-card high-confidence hover-lift border-l-4 border-l-green-500">
                                    <div class="p-4">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h6 class="font-semibold text-lg">{{ stock.symbol }}</h6>
                                                <p class="text-sm text-gray-600">{{ stock.stock_name }}</p>
                                            </div>
                                            <div class="text-right">
                                                <span class="score">{{ "%.3f"|format(stock.total_score) }}</span>
                                                <div class="text-xs text-green-600 font-semibold mt-1">å¼ºçƒˆæ¨è</div>
                                            </div>
                                        </div>
                                        
                                        <div class="flex justify-between items-center mb-3">
                                            <div class="price">Â¥{{ "%.2f"|format(stock.current_price) }}</div>
                                            <span class="badge badge-secondary">{{ stock.market }}</span>
                                        </div>
                                        
                                        <div class="grid grid-cols-3 gap-2 text-center text-sm mb-3">
                                            <div>
                                                <p class="text-gray-600 text-xs">ç«ä»·</p>
                                                <p class="{% if stock.auction_ratio > 0 %}text-green-600{% else %}text-red-600{% endif %} font-semibold">
                                                    {{ "%+.1f"|format(stock.auction_ratio) }}%
                                                </p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600 text-xs">ç›®æ ‡ä»·</p>
                                                <p class="text-green-600 font-semibold">Â¥{{ "%.2f"|format(stock.target_price) }}</p>
                                            </div>
                                            <div>
                                                <p class="text-gray-600 text-xs">æ­¢æŸä»·</p>
                                                <p class="text-red-600 font-semibold">Â¥{{ "%.2f"|format(stock.stop_loss) }}</p>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <p class="text-xs text-gray-600 bg-gray-50 p-2 rounded">{{ stock.strategy }}</p>
                                        </div>
                                        
                                        <div class="flex space-x-2">
                                            <button class="button button-sm button-primary flex-1" onclick="addToWatchlist('{{ stock.symbol }}')">
                                                <i data-lucide="eye" class="w-3 h-3 mr-1"></i>å…³æ³¨
                                            </button>
                                            <button class="button button-sm button-outline" onclick="showStockDetail('{{ stock.symbol }}')">
                                                è¯¦æƒ…
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if high_stocks %}
                        <div class="mb-6">
                            <div class="flex items-center mb-3">
                                <i data-lucide="trending-up" class="w-5 h-5 text-blue-500 mr-2"></i>
                                <h3 class="text-lg font-semibold text-blue-600">å€¼å¾—å…³æ³¨ ({{ high_stocks|length }}åª)</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                {% for stock in high_stocks %}
                                <div class="card stock-card medium-confidence hover-lift border-l-4 border-l-blue-500">
                                    <div class="p-3">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <h6 class="font-semibold">{{ stock.symbol }}</h6>
                                                <p class="text-xs text-gray-600">{{ stock.stock_name }}</p>
                                            </div>
                                            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">{{ "%.3f"|format(stock.total_score) }}</span>
                                        </div>
                                        
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="text-sm font-semibold">Â¥{{ "%.2f"|format(stock.current_price) }}</div>
                                            <span class="text-xs {% if stock.auction_ratio > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                                {{ "%+.1f"|format(stock.auction_ratio) }}%
                                            </span>
                                        </div>
                                        
                                        <button class="w-full button button-sm button-outline" onclick="addToWatchlist('{{ stock.symbol }}')">
                                            <i data-lucide="plus" class="w-3 h-3 mr-1"></i>åŠ å…¥å…³æ³¨
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if medium_stocks and medium_stocks|length > 0 %}
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <i data-lucide="bar-chart" class="w-5 h-5 text-gray-500 mr-2"></i>
                                    <h3 class="text-lg font-semibold text-gray-600">å…¶ä»–æœºä¼š ({{ medium_stocks|length }}åª)</h3>
                                </div>
                                <button class="button button-sm button-ghost" onclick="toggleOtherStocks()">
                                    <span id="toggleText">å±•å¼€æŸ¥çœ‹</span>
                                    <i data-lucide="chevron-down" id="toggleIcon" class="w-4 h-4 ml-1"></i>
                                </button>
                            </div>
                            <div id="otherStocksContainer" class="hidden">
                                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                                    {% for stock in medium_stocks %}
                                    <div class="card p-2 text-center hover-lift">
                                        <div class="text-sm font-semibold">{{ stock.symbol }}</div>
                                        <div class="text-xs text-gray-600 truncate">{{ stock.stock_name }}</div>
                                        <div class="text-xs font-semibold mt-1">Â¥{{ "%.2f"|format(stock.current_price) }}</div>
                                        <div class="text-xs {% if stock.auction_ratio > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                            {{ "%+.1f"|format(stock.auction_ratio) }}%
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-8">
                            <i data-lucide="inbox" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <h6 class="text-gray-600 font-semibold mb-2">æš‚æ— æ¨èè‚¡ç¥¨</h6>
                            <p class="text-gray-500 mb-4">ç‚¹å‡»"ç«‹å³åˆ†æ"å¼€å§‹è‚¡ç¥¨ç­›é€‰</p>
                            <button class="button button-primary" onclick="runAnalysis()">
                                <i data-lucide="play" class="w-4 h-4 mr-2"></i>å¼€å§‹åˆ†æ
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿä¿¡æ¯é¢æ¿ -->
        <div class="space-y-4">
            <!-- å®æ—¶æ—¶é’Ÿ -->
            <div class="card">
                <div class="p-4 border-b">
                    <h6 class="font-semibold flex items-center">
                        <i data-lucide="clock" class="w-4 h-4 mr-2"></i>
                        äº¤æ˜“æ—¶é—´
                    </h6>
                </div>
                <div class="p-6 text-center">
                    <div id="trading-clock">
                        <div class="text-xl font-semibold text-blue-600 mb-2" id="current-date"></div>
                        <div class="text-3xl font-bold text-gray-900 mb-4" id="current-time-large"></div>
                        <div>
                            <span id="market-status" class="badge badge-secondary">å¸‚åœºçŠ¶æ€æ£€æµ‹ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="card">
                <div class="p-4 border-b">
                    <h6 class="font-semibold flex items-center">
                        <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                        å¿«é€Ÿæ“ä½œ
                    </h6>
                </div>
                <div class="p-4">
                    <div class="space-y-2">
                        <button class="w-full button button-primary" onclick="runAnalysis()">
                            <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i>ç«‹å³åˆ†æ
                        </button>
                        <button class="w-full button button-outline" onclick="testEmail()">
                            <i data-lucide="send" class="w-4 h-4 mr-2"></i>æµ‹è¯•é‚®ä»¶
                        </button>
                        <button class="w-full button button-outline" onclick="refreshStatus()">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>åˆ·æ–°çŠ¶æ€
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿæç¤º -->
            <div class="card">
                <div class="p-4 border-b">
                    <h6 class="font-semibold flex items-center">
                        <i data-lucide="lightbulb" class="w-4 h-4 mr-2"></i>
                        ç³»ç»Ÿæç¤º
                    </h6>
                </div>
                <div class="p-4 space-y-3">
                    <div class="alert alert-default">
                        <div class="flex items-start">
                            <i data-lucide="info" class="w-4 h-4 mr-2 mt-0.5 text-blue-500"></i>
                            <p class="text-sm">äº¤æ˜“æ—¥ 9:25-9:29 ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†æå¹¶å‘é€é‚®ä»¶æ¨è</p>
                        </div>
                    </div>
                    <div class="alert alert-default">
                        <div class="flex items-start">
                            <i data-lucide="alert-triangle" class="w-4 h-4 mr-2 mt-0.5 text-yellow-500"></i>
                            <p class="text-sm">æŠ•èµ„æœ‰é£é™©ï¼Œå†³ç­–éœ€è°¨æ…ã€‚æœ¬ç³»ç»Ÿä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // æ›´æ–°å¤§æ—¶é’Ÿ
    function updateLargeClock() {
        const now = new Date();
        const dateString = now.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
        });
        const timeString = now.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        document.getElementById('current-date').textContent = dateString;
        document.getElementById('current-time-large').textContent = timeString;
        
        // æ›´æ–°å¸‚åœºçŠ¶æ€
        updateMarketStatus(now);
    }
    
    // æ›´æ–°å¸‚åœºçŠ¶æ€
    function updateMarketStatus(now) {
        const hour = now.getHours();
        const minute = now.getMinutes();
        const weekday = now.getDay();
        const statusElement = document.getElementById('market-status');
        
        // ç®€åŒ–çš„å¸‚åœºçŠ¶æ€åˆ¤æ–­
        if (weekday === 0 || weekday === 6) {
            statusElement.textContent = 'ä¼‘å¸‚';
            statusElement.className = 'badge bg-secondary';
        } else if ((hour === 9 && minute >= 15 && minute <= 25)) {
            statusElement.textContent = 'é›†åˆç«ä»·';
            statusElement.className = 'badge bg-warning';
        } else if ((hour === 9 && minute >= 30) || (hour >= 10 && hour < 11) || 
                   (hour === 11 && minute < 30) || (hour === 13) || 
                   (hour === 14) || (hour === 15 && minute === 0)) {
            statusElement.textContent = 'äº¤æ˜“ä¸­';
            statusElement.className = 'badge bg-success';
        } else {
            statusElement.textContent = 'ä¼‘å¸‚';
            statusElement.className = 'badge bg-secondary';
        }
    }
    
    // å¯åŠ¨/åœæ­¢è°ƒåº¦å™¨
    function toggleScheduler() {
        const isRunning = {{ 'true' if system_status.scheduler_running else 'false' }};
        const url = isRunning ? '/api/stop_scheduler' : '/api/start_scheduler';
        const action = isRunning ? 'åœæ­¢' : 'å¯åŠ¨';
        
        makeRequest(url, 'POST')
            .then(response => {
                if (response.success) {
                    showNotification(response.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(response.message, 'danger');
                }
            });
    }
    
    // è¿è¡Œåˆ†æ
    function runAnalysis() {
        // å¼€å§‹åˆ†æå‰çš„UIæ›´æ–°
        showAnalysisProgress('å‡†å¤‡ä¸­...', 0);
        
        // ç¦ç”¨æ‰€æœ‰åˆ†ææŒ‰é’®
        const analysisButtons = document.querySelectorAll('button[onclick="runAnalysis()"]');
        analysisButtons.forEach(btn => {
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>åˆ†æä¸­...';
            btn.setAttribute('data-original-text', originalText);
        });
        
        // æ˜¾ç¤ºåˆ†æçŠ¶æ€
        showNotification('ğŸ” å¼€å§‹æ‰§è¡Œè‚¡ç¥¨åˆ†æ...', 'info');
        
        // æ¨¡æ‹Ÿåˆ†æè¿›åº¦
        let progress = 10;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += Math.random() * 20;
                showAnalysisProgress(`åˆ†æä¸­... ${Math.min(90, Math.round(progress))}%`, Math.min(90, progress));
            }
        }, 500);
        
        makeRequest('/api/run_analysis', 'POST')
            .then(response => {
                clearInterval(progressInterval);
                
                if (response.success) {
                    // å®Œæˆè¿›åº¦
                    showAnalysisProgress('åˆ†æå®Œæˆï¼', 100);
                    
                    // æ˜¾ç¤ºè¯¦ç»†çš„åˆ†æç»“æœ
                    let detailedMessage = response.message;
                    if (response.data) {
                        const data = response.data;
                        detailedMessage += `\nğŸ“ˆ å¹³å‡è¯„åˆ†: ${data.average_score}`;
                        if (data.low_price_count > 0) {
                            detailedMessage += `\nğŸ’° åŒ…å« ${data.low_price_count} åªä½ä»·æœºä¼šè‚¡`;
                        }
                    }
                    
                    showNotification(detailedMessage, 'success');
                    
                    // å»¶è¿Ÿæ›´æ–°æ¨èå†…å®¹ï¼Œç»™ç”¨æˆ·çœ‹åˆ°å®ŒæˆçŠ¶æ€
                    setTimeout(() => {
                        updateRecommendations(response.data);
                        hideAnalysisProgress();
                    }, 1500);
                } else {
                    showAnalysisProgress('åˆ†æå¤±è´¥', 0);
                    showNotification(`âŒ ${response.message}`, 'danger');
                    setTimeout(() => hideAnalysisProgress(), 2000);
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                showAnalysisProgress('åˆ†æå¤±è´¥', 0);
                showNotification('âŒ åˆ†æè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'danger');
                setTimeout(() => hideAnalysisProgress(), 2000);
            })
            .finally(() => {
                // æ¢å¤åˆ†ææŒ‰é’®
                setTimeout(() => {
                    analysisButtons.forEach(btn => {
                        btn.disabled = false;
                        const originalText = btn.getAttribute('data-original-text');
                        if (originalText) {
                            btn.innerHTML = originalText;
                            btn.removeAttribute('data-original-text');
                        }
                        lucide.createIcons();
                    });
                }, 2000);
            });
    }
    
    // æ˜¾ç¤ºåˆ†æè¿›åº¦
    function showAnalysisProgress(message, percentage) {
        let progressBar = document.getElementById('analysis-progress-bar');
        if (!progressBar) {
            // åˆ›å»ºè¿›åº¦æ¡å…ƒç´ 
            const progressContainer = document.createElement('div');
            progressContainer.id = 'analysis-progress-container';
            progressContainer.className = 'fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-4 z-50 min-w-80';
            progressContainer.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <i data-lucide="activity" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-gray-900" id="analysis-progress-text">${message}</div>
                        <div class="mt-2">
                            <div class="bg-gray-200 rounded-full h-2">
                                <div id="analysis-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1" id="analysis-progress-percentage">${Math.round(percentage)}%</div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressContainer);
            lucide.createIcons();
        } else {
            // æ›´æ–°ç°æœ‰è¿›åº¦æ¡
            document.getElementById('analysis-progress-text').textContent = message;
            progressBar.style.width = percentage + '%';
            document.getElementById('analysis-progress-percentage').textContent = Math.round(percentage) + '%';
        }
    }
    
    // éšè—åˆ†æè¿›åº¦
    function hideAnalysisProgress() {
        const progressContainer = document.getElementById('analysis-progress-container');
        if (progressContainer) {
            progressContainer.remove();
        }
    }
    
    // æ›´æ–°æ¨èå†…å®¹ï¼ˆä¸é‡æ–°åŠ è½½æ•´ä¸ªé¡µé¢ï¼‰
    function updateRecommendations(analysisData = null) {
        makeRequest('/api/system_status')
            .then(status => {
                if (!status.error) {
                    // æ›´æ–°ä»Šæ—¥æ¨èæ•°é‡
                    const recommendationCountElement = document.querySelector('.text-2xl.font-bold.text-blue-600');
                    if (recommendationCountElement && status.today_recommendations) {
                        recommendationCountElement.textContent = status.today_recommendations;
                        
                        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                        recommendationCountElement.classList.add('animate-pulse');
                        setTimeout(() => {
                            recommendationCountElement.classList.remove('animate-pulse');
                        }, 2000);
                    }
                    
                    // æ˜¾ç¤ºè¯¦ç»†çš„æ›´æ–°æˆåŠŸæ¶ˆæ¯
                    let updateMessage = `ğŸ“Š æ¨èå·²æ›´æ–°ï¼Œå…±æ‰¾åˆ° ${status.today_recommendations} åªè‚¡ç¥¨`;
                    if (analysisData) {
                        if (analysisData.high_confidence_count > 0) {
                            updateMessage += `ï¼Œå¼ºçƒˆæ¨è ${analysisData.high_confidence_count} åª`;
                        }
                        if (analysisData.low_price_count > 0) {
                            updateMessage += `ï¼Œä½ä»·æœºä¼š ${analysisData.low_price_count} åª`;
                        }
                    }
                    
                    showNotification(updateMessage, 'success');
                    
                    // 3ç§’ååˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ¨è
                    setTimeout(() => {
                        showNotification('ğŸ”„ æ­£åœ¨åŠ è½½æœ€æ–°æ¨è...', 'info');
                        location.reload();
                    }, 3000);
                }
            })
            .catch(error => {
                showNotification('çŠ¶æ€æ›´æ–°å¤±è´¥ï¼Œå°†ç›´æ¥åˆ·æ–°é¡µé¢', 'warning');
                setTimeout(() => location.reload(), 2000);
            });
    }
    
    // æµ‹è¯•é‚®ä»¶
    function testEmail() {
        showNotification('æ­£åœ¨å‘é€æµ‹è¯•é‚®ä»¶...', 'info');
        
        makeRequest('/api/test_email', 'POST')
            .then(response => {
                if (response.success) {
                    showNotification(response.message, 'success');
                } else {
                    showNotification(response.message, 'danger');
                }
            });
    }
    
    // åˆ·æ–°çŠ¶æ€ï¼ˆæ”¹ä¸ºä¸é‡æ–°åŠ è½½é¡µé¢ï¼‰
    function refreshStatus() {
        makeRequest('/api/system_status')
            .then(response => {
                if (!response.error) {
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºè€Œä¸é‡æ–°åŠ è½½é¡µé¢
                    updateStatusDisplay(response);
                    showNotification('çŠ¶æ€å·²åˆ·æ–°', 'info');
                } else {
                    showNotification('åˆ·æ–°å¤±è´¥: ' + response.error, 'danger');
                }
            });
    }
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatusDisplay(status) {
        // æ›´æ–°ä»Šæ—¥æ¨èæ•°é‡
        const recommendationCountElement = document.querySelector('.text-2xl.font-bold.text-blue-600');
        if (recommendationCountElement && status.today_recommendations !== undefined) {
            recommendationCountElement.textContent = status.today_recommendations;
        }
        
        // æ›´æ–°è°ƒåº¦å™¨çŠ¶æ€ï¼ˆå¯é€‰å®ç°ï¼‰
        // å¦‚æœéœ€è¦æ›´æ–°å…¶ä»–çŠ¶æ€æ˜¾ç¤ºï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
    }
    
    // åˆ‡æ¢å…¶ä»–è‚¡ç¥¨æ˜¾ç¤º
    function toggleOtherStocks() {
        const container = document.getElementById('otherStocksContainer');
        const toggleText = document.getElementById('toggleText');
        const toggleIcon = document.getElementById('toggleIcon');
        
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            toggleText.textContent = 'æ”¶èµ·';
            toggleIcon.setAttribute('data-lucide', 'chevron-up');
        } else {
            container.classList.add('hidden');
            toggleText.textContent = 'å±•å¼€æŸ¥çœ‹';
            toggleIcon.setAttribute('data-lucide', 'chevron-down');
        }
        lucide.createIcons();
    }
    
    // æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨
    function addToWatchlist(symbol) {
        // è¿™é‡Œå¯ä»¥å®ç°æ·»åŠ åˆ°è‡ªé€‰è‚¡çš„åŠŸèƒ½
        showNotification(`å·²å°† ${symbol} æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨`, 'default');
        
        // å¯ä»¥è°ƒç”¨APIä¿å­˜åˆ°æœåŠ¡å™¨
        // makeRequest('/api/add_to_watchlist', 'POST', { symbol: symbol })
    }
    
    // æ˜¾ç¤ºè‚¡ç¥¨è¯¦æƒ…ï¼ˆç®€åŒ–ç‰ˆï¼‰
    function showStockDetail(symbol) {
        // è·³è½¬åˆ°æ¨èé¡µé¢å¹¶æ˜¾ç¤ºè¯¥è‚¡ç¥¨è¯¦æƒ…
        window.location.href = `/recommendations#${symbol}`;
    }

    // æ¯ç§’æ›´æ–°å¤§æ—¶é’Ÿ
    setInterval(updateLargeClock, 1000);
    updateLargeClock();
    
    // æ¯5åˆ†é’Ÿé™é»˜æ›´æ–°ç³»ç»ŸçŠ¶æ€ï¼ˆä¸æ˜¾ç¤ºé€šçŸ¥ï¼Œä¸é‡æ–°åŠ è½½é¡µé¢ï¼‰
    setInterval(() => {
        makeRequest('/api/system_status')
            .then(response => {
                if (!response.error) {
                    updateStatusDisplay(response);
                }
            })
            .catch(error => {
                console.log('å®šæ—¶çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
            });
    }, 300000); // 5åˆ†é’Ÿ = 300000æ¯«ç§’
</script>
{% endblock %}