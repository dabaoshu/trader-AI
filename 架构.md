# 智能选股助手 — 业务架构图

> 基于项目全部 Python 业务代码分析生成

---

## 一、系统全局架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用户层 (User Layer)                         │
├────────────────────┬────────────────────┬───────────────────────────┤
│  Flask Web UI      │  Vue3 管理后台     │  邮件日报（自动推送）      │
│  localhost:8080    │  localhost:5173    │  SMTP → 用户邮箱          │
└────────┬───────────┴────────┬───────────┴─────────┬─────────────────┘
         │                    │ (API Proxy)          │
         ▼                    ▼                      │
┌─────────────────────────────────────────────┐      │
│            Flask API 网关 (app.py)          │      │
│  ┌──────────┬──────────┬──────────────────┐ │      │
│  │ 页面路由  │ 选股API  │ 系统/邮件/调度API│ │      │
│  └──────────┴──────────┴──────────────────┘ │      │
└──────┬──────────┬──────────┬────────────────┘      │
       │          │          │                       │
       ▼          ▼          ▼                       │
┌──────────┐ ┌──────────┐ ┌───────────────┐         │
│ 条件选股  │ │ 股票分析  │ │  定时调度器    │─────────┘
│  引擎    │ │  引擎    │ │ (Scheduler)   │
└──────────┘ └──────────┘ └───────────────┘
       │          │               │
       ▼          ▼               ▼
┌─────────────────────────────────────────────┐
│          数据层 (Data Layer)                 │
│  ┌──────────┐  ┌──────────┐  ┌───────────┐ │
│  │ SQLite   │  │ BaoStock │  │  AKShare  │ │
│  │ 本地数据库│  │ 股票API  │  │ 金融API   │ │
│  └──────────┘  └──────────┘  └───────────┘ │
└─────────────────────────────────────────────┘
```

---

## 二、核心业务模块关系图

```
                        ┌─────────────────────────┐
                        │    backend/app.py        │
                        │    (Flask 主应用)         │
                        │                          │
                        │  WebAppManager           │
                        │  ├─ init_database()      │
                        │  ├─ get_recommendations() │
                        │  ├─ save_recommendations()│
                        │  ├─ get_system_status()   │
                        │  └─ save_email_config()   │
                        └────┬───────┬────────┬────┘
                             │       │        │
              ┌──────────────┘       │        └──────────────────┐
              ▼                      ▼                           ▼
┌──────────────────────┐  ┌───────────────────────┐  ┌────────────────────┐
│  stock_screener/     │  │  analysis/            │  │  backend/services/ │
│                      │  │                       │  │                    │
│  StockScreener       │  │  OptimizedStock       │  │  EmailSender       │
│  ├─ screen()         │  │  Analyzer             │  │  ├─ send_daily_    │
│  ├─ screen_with_     │  │  ├─ get_enhanced_     │  │  │   report()      │
│  │   preset()        │  │  │   stock_pool()     │  │  ├─ send_test_     │
│  ├─ _match()         │  │  ├─ analyze_stock_    │  │  │   email()       │
│  └─ _eval_custom_    │  │  │   with_fallback()  │  │  └─ _connect_     │
│     rule()           │  │  ├─ _calculate_       │  │      smtp()        │
│                      │  │  │   relaxed_tech_    │  │                    │
│  ScreenerRecord      │  │  │   score()          │  └────────────────────┘
│  Manager             │  │  └─ generate_         │
│  ├─ save_record()    │  │     optimized_        │
│  ├─ get_records()    │  │     recommendations() │
│  ├─ get_record_      │  │                       │
│  │   by_id()         │  │  DeepStockAnalyzer    │
│  └─ delete_record()  │  │  ├─ generate_deep_    │
│                      │  │  │   analysis_report() │
└──────────────────────┘  │  ├─ _get_real_data()  │
                          │  └─ _generate_llm_    │
                          │     analysis()         │
                          │                       │
                          │  TradingDayScheduler  │
                          │  ├─ start_scheduler() │
                          │  ├─ is_trading_time() │
                          │  └─ execute_daily_    │
                          │     report()           │
                          └───────────────────────┘
```

---

## 三、核心业务流程

### 3.1 股票分析主流程

```
用户点击"立即分析"
        │
        ▼
  POST /api/run_analysis
        │
        ▼
  OptimizedStockAnalyzer.generate_optimized_recommendations()
        │
        ├─────────────────────────────────────┐
        ▼                                     ▼
  get_enhanced_stock_pool()          get_strategy_config()
        │                              (从 SQLite 读取)
        │
        ├── 策略1: BaoStock API ──→ 获取A股全部股票
        │   └─ _process_baostock_data() ──→ 按市场分层抽样
        │       └─ _is_risky_stock() ──→ 过滤ST/退市风险股
        │
        └── 策略2: 降级 ──→ _get_predefined_stock_pool()
                             (33只预定义优质股票)
        │
        ▼
  逐只股票分析（循环）
        │
        ├── DeepStockAnalyzer（前3只深度分析）
        │   ├─ BaoStock 获取30日K线
        │   ├─ 计算技术指标（RSI/MACD/布林带/均线）
        │   ├─ 计算资金流向和情绪指标
        │   └─ LLM 分析（当前为模拟响应）
        │
        └── analyze_stock_with_fallback()（其余股票）
            ├─ 尝试1: _analyze_with_real_data()
            │   ├─ BaoStock 获取历史K线
            │   ├─ _calculate_relaxed_tech_score() ──→ 均线/趋势/量能评分
            │   └─ _generate_auction_score() ──→ 竞价数据评分
            │
            └─ 降级: _analyze_with_simulated_data()
                └─ 基于代码生成稳定的模拟数据
        │
        ▼
  综合评分 = 技术评分 × tech_weight + 竞价评分 × auction_weight
        │
        ▼
  排序 + 截取 top N（默认15只）
        │
        ├──→ generate_explain() ──→ 生成自然语言策略解释
        │    （买入理由/卖出策略/风险收益/目标价区间）
        │
        ├──→ build_explain_html() ──→ 生成HTML分析报告片段
        │    （保存到 stock_analysis 表）
        │
        └──→ save_recommendations() ──→ 保存到 stock_recommendations 表
        │
        ▼
  返回 JSON: { recommendations, market_summary, auction_analysis }
```

### 3.2 条件选股流程

```
用户设置筛选条件（或选择预置模板）
        │
        ▼
  POST /api/screener/run
        │
        ├── preset_key? ──→ 加载预置模板条件
        │
        ▼
  获取候选股票池
        │
        ├── 优先: 从 stock_recommendations 读取当日推荐
        └── 备用: OptimizedStockAnalyzer 实时生成
        │
        ▼
  StockScreener.screen(candidate_pool, conditions)
        │
        ▼
  逐只股票匹配 _match()
        │
        ├── 价格区间检查
        ├── 综合评分/技术评分/竞价评分 范围检查
        ├── 竞价涨幅范围检查
        ├── RSI 范围检查
        ├── 市值范围检查
        ├── 跳空类型匹配
        ├── 信心等级匹配
        ├── 市场板块匹配
        ├── 关键词搜索（代码/名称）
        └── 手动自定义规则 _eval_custom_rule()
            （field + op + value，支持 gt/gte/lt/lte/eq/neq/contains）
        │
        ▼
  按 total_score 降序排序
        │
        ▼
  ScreenerRecordManager.save_record()
        │
        ├── 保存完整条件 JSON (conditions)
        ├── 保存完整结果列表 (result_data)
        ├── 保存结果摘要 (result_summary)
        └── 保存股票代码列表 (result_symbols)
        │
        ▼
  返回 JSON: { record_id, total, stocks }
```

### 3.3 定时日报流程

```
app.py 启动 → 用户点击"启动调度"
        │
        ▼
  TradingDayScheduler.start_scheduler()
        │
        ▼
  schedule 库每30秒检查 ──→ is_trading_time()?
        │                         │
        │              No ←───────┘
        │                         │ Yes
        ▼                         ▼
  继续等待              should_send_report()?
                              │
                     Yes ◄────┘
                              │
                              ▼
                  DailyReportGenerator
                  .generate_and_send_report()
                              │
                  ┌───────────┤
                  ▼           ▼
           分析股票       生成邮件内容
        (与3.1相同)    (HTML模板渲染)
                  │           │
                  ▼           ▼
           保存结果       EmailSender
           到数据库    .send_daily_report()
                              │
                              ▼
                    SMTP 发送到接收邮箱
```

---

## 四、数据库表结构

```
SQLite: data/cchan_web.db
│
├── stock_recommendations          ← 股票推荐结果
│   ├── id, date, symbol, stock_name, market
│   ├── current_price, total_score, tech_score
│   ├── auction_score, auction_ratio, gap_type
│   ├── confidence, strategy
│   ├── entry_price, stop_loss, target_price
│   ├── status (pending/bought/watching/ignored)
│   └── created_at
│
├── stock_analysis                 ← 深度分析 + 解释HTML
│   ├── symbol, stock_name, analysis_date
│   ├── total_score, tech_score, auction_score
│   ├── confidence, entry_price, stop_loss, target_price
│   ├── explanation (自然语言)
│   ├── explain_html (HTML片段)
│   ├── mini_prices (价格JSON)
│   └── created_at
│
├── deep_analysis                  ← LLM深度分析
│   ├── symbol, stock_name, analysis_date
│   ├── current_price, price_change_pct, volume_ratio
│   ├── rsi_14, macd_signal, ma5/10/20/60
│   ├── bollinger_position, sentiment_score
│   ├── llm_analysis_text, investment_rating
│   └── created_at
│
├── screener_records               ← 条件选股记录
│   ├── id, name, conditions (JSON)
│   ├── result_count, result_symbols (JSON)
│   ├── result_summary (JSON), result_data (JSON)
│   ├── preset_key
│   └── created_at
│
├── system_config                  ← 策略参数配置
│   ├── config_key, config_value
│   └── updated_at
│
└── system_logs                    ← 系统日志
    ├── level, message
    └── created_at
```

---

## 五、模块文件索引

| 模块 | 文件 | 核心类/函数 | 职责 |
|------|------|------------|------|
| **Web主应用** | `backend/app.py` | `WebAppManager`, Flask路由 | HTTP入口、页面渲染、API网关 |
| **优化分析器** | `analysis/optimized_stock_analyzer.py` | `OptimizedStockAnalyzer` | 多策略降级的股票分析引擎 |
| **深度分析器** | `analysis/deep_stock_analyzer.py` | `DeepStockAnalyzer` | LLM集成深度投研分析 |
| **日报生成器** | `backend/daily_report_generator.py` | `DailyReportGenerator` | 股票数据获取、日报组装 |
| **定时调度器** | `analysis/trading_day_scheduler.py` | `TradingDayScheduler` | 交易日9:25自动触发分析+邮件 |
| **邮件服务** | `backend/services/email_config.py` | `EmailSender` | 多邮件商SMTP发送 |
| **策略解释** | `backend/explain_generator.py` | `generate_explain()` | 自然语言选股理由生成 |
| **HTML解释** | `backend/explain_builder.py` | `build_explain_html()` | 分析报告HTML片段构建 |
| **条件选股引擎** | `stock_screener/screener.py` | `StockScreener` | 多维度条件过滤 + 自定义规则 |
| **选股记录** | `stock_screener/models.py` | `ScreenerRecordManager` | 选股记录持久化（SQLite） |

---

## 六、外部依赖

| 依赖 | 用途 | 降级策略 |
|------|------|---------|
| **BaoStock** | A股历史K线、全市场股票列表 | 降级到预定义股票池 |
| **AKShare** | 金融数据辅助 | 分析器内部捕获异常跳过 |
| **SMTP 邮件** | 日报推送 | 可选功能，未配置时跳过 |
| **LLM API** | 深度投研分析 | 当前使用模拟响应 |
| **SQLite** | 本地持久化 | 自动创建，无外部依赖 |
