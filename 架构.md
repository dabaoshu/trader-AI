# 智能选股助手 — 业务架构图

## 一、系统全局架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户层 (Browser)                       │
│              Vue3 管理后台 :5173                          │
│  ┌─────────┬──────────┬──────────┬──────────┬─────────┐ │
│  │每日推荐 │条件选股  │股票分析  │自选股    │模型管理 │ │
│  └─────────┴──────────┴──────────┴──────────┴─────────┘ │
└──────────────────────┬──────────────────────────────────┘
                       │ HTTP / JSON
                       ▼
┌─────────────────────────────────────────────────────────┐
│              Flask API 服务 :8080                         │
│                  backend/app.py                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │ /api/daily/*    每日推荐                          │   │
│  │ /api/screener/* 条件选股                          │   │
│  │ /api/analyzer/* 股票分析                          │   │
│  │ /api/watchlist/* 自选股 + 实时行情                 │   │
│  │ /api/models/*   AI 模型管理                       │   │
│  │ /api/strategy/* 策略配置                          │   │
│  │ /api/scheduler/* 定时调度                         │   │
│  │ /api/email/*    邮件服务                          │   │
│  └──────────────────────────────────────────────────┘   │
└───┬───────────┬───────────┬──────────┬──────────────────┘
    │           │           │          │
    ▼           ▼           ▼          ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌──────────┐
│ SQLite │ │akshare │ │baostock│ │ AI Model │
│  本地  │ │ 行情   │ │ K线    │ │  API     │
└────────┘ └────────┘ └────────┘ └──────────┘
```

## 二、核心模块关系

```
backend/app.py (API 网关, ~320 行)
    │
    ├── WebAppManager ──────────── SQLite CRUD (推荐/配置/日志)
    │
    ├── stock_screener/
    │   ├── screener.py ────────── StockScreener (条件筛选 + 5 预置模板)
    │   ├── models.py ─────────── ScreenerRecordManager (记录持久化)
    │   ├── watchlist.py ──────── WatchlistManager (多分组自选股)
    │   ├── realtime_quote.py ─── 实时行情 (akshare 全市场快照)
    │   └── analyzer/
    │       ├── engine.py ─────── StockAnalysisEngine (动态规则加载)
    │       ├── base_rule.py ──── BaseAnalysisRule (规则抽象基类)
    │       ├── ai_model.py ───── AIModelManager (统一模型调用)
    │       └── rules/ ────────── 6 条内置规则
    │
    ├── analysis/
    │   ├── optimized_stock_analyzer.py ── 每日分析器 (BaoStock + 降级)
    │   ├── deep_stock_analyzer.py ─────── 深度 LLM 分析
    │   └── trading_day_scheduler.py ───── 交易日 9:25 自动调度
    │
    └── backend/
        ├── daily_report_generator.py ──── 日报数据组装
        ├── explain_builder.py ─────────── 分析 HTML 片段
        ├── explain_generator.py ──────── 策略自然语言解释
        └── services/email_config.py ───── SMTP 邮件发送
```

## 三、业务流程

### 3.1 每日推荐

```
用户点击「立即分析」
    │
    ▼
POST /api/daily/run_analysis
    │
    ▼
OptimizedStockAnalyzer.generate_optimized_recommendations()
    │
    ├── BaoStock 获取股票池 (失败则用预定义 33 只)
    ├── 逐只分析: 技术评分 × 0.65 + 竞价评分 × 0.35
    ├── 排序取 top 15
    ├── 生成策略解释 (explain_generator)
    └── 保存到 stock_recommendations 表
    │
    ▼
GET /api/daily/recommendations → Vue DailyView 三级分组展示
```

### 3.2 条件选股

```
用户设置条件（或选预置模板）
    │
    ▼
POST /api/screener/run
    │
    ├── 候选池: stock_recommendations 当日数据
    ├── StockScreener.screen(): 逐条匹配全部条件
    │   (价格/评分/竞价/RSI/市值/板块/信心/关键词/自定义规则)
    ├── ScreenerRecordManager.save_record(): 保存条件 + 完整结果
    └── 返回 → Vue ScreenerView 表格展示
```

### 3.3 股票分析（动态规则）

```
用户输入股票代码 (支持 A股/港股/美股)
    │
    ▼
POST /api/analyzer/analyze
    │
    ├── 自动检测市场: 6位数字=A股, 5位=港股, 字母=美股
    ├── akshare 获取 180 天 K 线
    ├── calc_technical(): MA/RSI/MACD/BB/Volume
    ├── 遍历激活规则:
    │   ├── technical_rule  (权重 40%)
    │   ├── fundamental_rule (权重 40%)
    │   ├── sentiment_rule  (权重 20%)
    │   └── sector_*        (可选叠加)
    ├── 加权综合评分 → 投资建议
    └── 返回 → Vue AnalyzerView 仪表盘展示
```

### 3.4 自选股实时行情

```
Vue WatchlistView 加载
    │
    ├── GET /api/watchlist/groups/<id>/stocks → 股票列表
    ├── POST /api/watchlist/quotes (symbols) → 实时行情
    │   └── akshare stock_zh_a_spot_em() 全市场快照 (3s 缓存)
    └── setInterval(5000) → 每 5 秒轮询行情
```

### 3.5 AI 模型调用链

```
需要 AI 的模块调用 AIModelManager.chat(prompt, caller=xxx)
    │
    ├── 查 caller_mapping: caller → provider_id
    ├── 查 default_provider_id (未映射时)
    ├── 取 provider 配置: base_url + model_id + api_key
    └── POST {base_url}/chat/completions → 返回文本
```

## 四、数据库表

```
SQLite: data/cchan_web.db
│
├── stock_recommendations   ← 每日推荐结果
├── system_config           ← 策略参数 (key-value)
├── system_logs             ← 系统日志
├── screener_records        ← 条件选股记录 (条件+完整结果)
├── watchlist_groups        ← 自选股分组
├── watchlist_stocks        ← 自选股票
├── stock_analysis          ← 深度分析结果
└── deep_analysis           ← LLM 分析结果

JSON: data/ai_models.json   ← AI 模型提供商配置 + 调用者映射
```

## 五、文件清单

| 目录 | 文件数 | 说明 |
|------|-------|------|
| `backend/` | 5 | Flask API + 日报 + 邮件 + 解释生成 |
| `analysis/` | 3 | 分析引擎 + 调度器 |
| `stock_screener/` | 12 | 选股/自选/行情/分析规则引擎/AI模型 |
| `admin-panel/src/` | 14 | Vue3 TS 前端 (7 页面 + 2 组件 + 路由/类型/API) |
| 根目录 | 3 | dev.sh + requirements.txt + 文档 |
| **总计** | **~37 核心文件** | |
